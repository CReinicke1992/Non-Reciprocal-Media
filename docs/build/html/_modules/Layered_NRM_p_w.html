
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Layered_NRM_p_w &#8212; Non-reciprocal wavefields (1.5 D) 28-03-2018 documentation</title>
    <link rel="stylesheet" href="../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Non-reciprocal wavefields (1.5 D) 28-03-2018 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for Layered_NRM_p_w</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Routines for modelling wavefields in 1D non-reciprocal media.</span>

<span class="sd">.. module:: Wavefield_NRM_p_w</span>

<span class="sd">:Authors:</span>
<span class="sd">    Christian Reinicke (c.reinicke@tudelft.nl), Kees Wapenaar (), and Evert Slob ()</span>
<span class="sd">    </span>
<span class="sd">:Copyright:</span>
<span class="sd">    Christian Reinicke (c.reinicke@tudelft.nl), Kees Wapenaar (), and Evert Slob ()</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">Wavefield_NRM_p_w</span> <span class="k">import</span> <span class="n">Wavefield_NRM_p_w</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">sys</span>

<div class="viewcode-block" id="Layered_NRM_p_w"><a class="viewcode-back" href="../Layered_NRM_p_w.html#Layered_NRM_p_w.Layered_NRM_p_w">[docs]</a><span class="k">class</span> <span class="nc">Layered_NRM_p_w</span><span class="p">(</span><span class="n">Wavefield_NRM_p_w</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;is a class to model wavefields in 1D (non-)reciprocal media in the ray-parameter frequency domain.</span>
<span class="sd">        </span>
<span class="sd">    The class Layered_NRM_p_w defines a 1D (non-)reciprocal medium and a scalar wavefield. We consider a single horizontal ray-parameter &#39;p1&#39; and all frequencies that are sampled by the given number of time samples &#39;nt&#39; and the time sample interval &#39;dt&#39;.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    </span>
<span class="sd">    nt : int</span>
<span class="sd">        Number of time samples.</span>
<span class="sd">        </span>
<span class="sd">    dt : int, float</span>
<span class="sd">        Time sample interval in seconds.</span>
<span class="sd">        </span>
<span class="sd">    nr : int, optional</span>
<span class="sd">        Number of space samples.</span>
<span class="sd">    </span>
<span class="sd">    dx1 : int, float, optional</span>
<span class="sd">        Space sample interval.</span>
<span class="sd">        </span>
<span class="sd">    verbose : bool, optional</span>
<span class="sd">        Set &#39;verbose=True&#39; to receive feedback in the command line.</span>
<span class="sd">        </span>
<span class="sd">    x3vec : numpy.ndarray</span>
<span class="sd">        Vertical spatial vector :math:`x_3`, for n layers &#39;x3vec&#39; must have the shape (n,). We define the :math:`x_3`-axis as downward-pointing. Implicitly, the first value on the :math:`x_3`-axis is zero (not stored in &#39;x3vec&#39;).</span>
<span class="sd">    </span>
<span class="sd">    avec : numpy.ndarray</span>
<span class="sd">        Medium parameter :math:`\\alpha` (real-valued), for n layers &#39;avec&#39; must have the shape (n,).</span>
<span class="sd">        </span>
<span class="sd">    bvec : numpy.ndarray</span>
<span class="sd">        Medium parameter :math:`\\beta` (real-valued), for n layers &#39;bvec&#39; must have the shape (n,).</span>
<span class="sd">    </span>
<span class="sd">    g1vec : numpy.ndarray, optional</span>
<span class="sd">        Medium parameter :math:`\gamma_1` (real-valued for non-reciprocal media or imaginary-valued for reciprocal media), for n layers &#39;g1vec&#39; must have the shape (n,).</span>
<span class="sd">        </span>
<span class="sd">    g3vec : numpy.ndarray, optional</span>
<span class="sd">        Medium parameter :math:`\gamma_3` (real-valued for non-reciprocal media or imaginary-valued for reciprocal media), for n layers &#39;g3vec&#39; must have the shape (n,).</span>
<span class="sd">        </span>
<span class="sd">    p1 : int, float</span>
<span class="sd">        Horizontal ray-parameter in seconds per metre.</span>
<span class="sd">        </span>
<span class="sd">    ReciprocalMedium : bool, optional</span>
<span class="sd">        For non-reciprocal media set &#39;ReciprocalMedium=False&#39;, for reciprocal media set &#39;ReciprocalMedium=True&#39;.</span>
<span class="sd">        </span>
<span class="sd">    AdjointMedium : bool, optional</span>
<span class="sd">        Set &#39;AdjointMedium=True&#39; to compute scattering coefficients and propagators in an adjoint medium :math:`^{(a)}`. For reciprocal media, the scattering coefficients and propagators are identical in a medium and its adjoint. We have defined the scattering and propagation in the adjoint medium only for flux-normalisation.</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    </span>
<span class="sd">    class</span>
<span class="sd">        A class to model a wavefield in a 1D non-reciprocal medium in the ray-parameter frequency domain. The following instances are defined:</span>
<span class="sd">             - **x3vec**: :math:`x_3`.</span>
<span class="sd">            - **avec**: :math:`\\alpha`.</span>
<span class="sd">            - **bvec**: :math:`\\beta`.</span>
<span class="sd">            - **g1vec**: :math:`\gamma_1`.</span>
<span class="sd">            - **g3vec**: :math:`\gamma_3`.</span>
<span class="sd">            - **p1**: Horizontal ray-parameter.</span>
<span class="sd">            - **ReciprocalMedium**: True for reciprocal media, False for non-reciprocal media.</span>
<span class="sd">            - **AdjointMedium**: If True, propagation and scatteing are defined in a medium and in its adjoint.</span>
<span class="sd">            - **p3**: Vertical ray-parameter for positive &#39;p1&#39;.</span>
<span class="sd">            - **p3n**: Vertical ray-parameter for negative &#39;p1&#39;.</span>
<span class="sd">        </span>
<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    - We format the data as described below.</span>
<span class="sd">        - Wavefields are saved in an array of dimensions (nf,nr) in the frequency domain and (nt,nr) in the time domain.</span>
<span class="sd">        - Wavefields are in the p- :math:`\omega` domain.</span>
<span class="sd">        - The zero frequency component is placed at the first index position.</span>
<span class="sd">        - If the wavefield is transformed to the time domain, the zero time component is placed at the first index position, followed by nt/2-1 positive time samples and nt/2 negative time samples.</span>
<span class="sd">    - For evanescent waves, Kees makes a sign choice for the vertical ray-parameter,</span>
<span class="sd">        - :math:`p_3&#39; = -j \sqrt{p_1^2 - (\\alpha \\beta + \gamma_1^2 + \gamma_3^2)}`.</span>
<span class="sd">      By default, **NumPy** makes the oppostie sign choice, </span>
<span class="sd">          - :math:`p_3&#39; = +j \sqrt{p_1^2 - (\\alpha \\beta + \gamma_1^2 + \gamma_3^2)}`.</span>
<span class="sd">      We stick to the sign choice by **NumPy**. Thus, we will also change the sign choice for the propagators,</span>
<span class="sd">          - Kees chose: :math:`\\tilde{w}^{\pm} = \mathrm{exp}(-j \omega p_3&#39; \Delta x_3)`.</span>
<span class="sd">          - We choose: :math:`\\tilde{w}^{\pm} = \mathrm{exp}(+j \omega p_3&#39; \Delta x_3)`.</span>
<span class="sd">        </span>
<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    Kees document as soon as it is published.</span>
<span class="sd">     </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    &gt;&gt;&gt; from Layered_NRM_p_w import Layered_NRM_p_w as LM</span>
<span class="sd">    &gt;&gt;&gt; import numpy as np</span>
<span class="sd">    </span>
<span class="sd">    &gt;&gt;&gt; # Initialise wavefield in a layered non-reciprocal medium</span>
<span class="sd">    &gt;&gt;&gt; F=LM(nt=1024,dt=0.005,x3vec=np.array([1.1,2.2,3.7]),avec=np.array([1,2,3]),bvec=np.array([0.4,3.14,2]),p1=2e-4,ReciprocalMedium=False)</span>
<span class="sd">        </span>
<span class="sd">    **Wavefield Quantities**</span>
<span class="sd">    (Do not change the table!)</span>
<span class="sd">    </span>
<span class="sd">    +---------------------------+--------------------+--------------------+---------------+--------------------+</span>
<span class="sd">    |                           | *TE*               | *TM*               | *Ac. (fluid)* | *SH (solid)*       |</span>
<span class="sd">    +===========================+====================+====================+===============+====================+</span>
<span class="sd">    | **P**                     | :math:`E_2`        | :math:`H_2`        | :math:`p`     | :math:`v_2`        |</span>
<span class="sd">    +---------------------------+--------------------+--------------------+---------------+--------------------+</span>
<span class="sd">    | :math:`\mathbf{Q}_1`      | :math:`H_3`        | :math:`-E_3`       | :math:`v_1`   | :math:`-\\tau_{21}` |</span>
<span class="sd">    +---------------------------+--------------------+--------------------+---------------+--------------------+</span>
<span class="sd">    | :math:`\mathbf{Q}_3`      | :math:`-H_1`       | :math:`E_1`        | :math:`v_3`   | :math:`-\\tau_{23}` |</span>
<span class="sd">    +---------------------------+--------------------+--------------------+---------------+--------------------+</span>
<span class="sd">    | :math:`\mathbf{\\alpha}`   | :math:`\epsilon`   | :math:`\mu`        | :math:`\kappa`| :math:`\\rho`       |</span>
<span class="sd">    +---------------------------+--------------------+--------------------+---------------+--------------------+</span>
<span class="sd">    | :math:`\mathbf{\\beta}`    | :math:`\mu`        | :math:`\epsilon`   | :math:`\\rho`  | :math:`1/\mu`      |</span>
<span class="sd">    +---------------------------+--------------------+--------------------+---------------+--------------------+</span>
<span class="sd">    | :math:`\mathbf{\gamma}_1` | :math:`\\xi_{23}`   | :math:`-\zeta_{23}`| :math:`d_1`   | :math:`e_1`        |</span>
<span class="sd">    +---------------------------+--------------------+--------------------+---------------+--------------------+</span>
<span class="sd">    | :math:`\mathbf{\gamma}_3` | :math:`-\\xi_{21}`  | :math:`\zeta_{21}` | :math:`d_3`   | :math:`e_3`        |</span>
<span class="sd">    +---------------------------+--------------------+--------------------+---------------+--------------------+</span>
<span class="sd">    | :math:`\mathbf{\delta}_1` | :math:`\zeta_{32}` | :math:`-\\xi_{32}`  | :math:`e_1`   | :math:`d_1`        |</span>
<span class="sd">    +---------------------------+--------------------+--------------------+---------------+--------------------+</span>
<span class="sd">    | :math:`\mathbf{\delta}_3` | :math:`-\zeta_{12}`| :math:`\\xi_{12}`   | :math:`e_3`   | :math:`d_3`        |</span>
<span class="sd">    +---------------------------+--------------------+--------------------+---------------+--------------------+</span>
<span class="sd">    | :math:`\mathbf{B}`        | :math:`-J_2^e`     | :math:`-J_2^m`     | :math:`q`     | :math:`f_2`        |</span>
<span class="sd">    +---------------------------+--------------------+--------------------+---------------+--------------------+</span>
<span class="sd">    | :math:`\mathbf{C}_1`      | :math:`-J_3^m`     | :math:`J_3^e`      | :math:`f_1`   | :math:`2h_{21}`    |</span>
<span class="sd">    +---------------------------+--------------------+--------------------+---------------+--------------------+</span>
<span class="sd">    | :math:`\mathbf{C}_3`      | :math:`J_1^m`      | :math:`-J_1^e`     | :math:`f_3`   | :math:`2h_{23}`    |</span>
<span class="sd">    +---------------------------+--------------------+--------------------+---------------+--------------------+</span>
<span class="sd">       </span>
<span class="sd">    </span>
<span class="sd">   &quot;&quot;&quot;</span>    
  
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">nt</span><span class="p">,</span><span class="n">dt</span><span class="p">,</span><span class="n">nr</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">dx1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">x3vec</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="n">avec</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="n">bvec</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="n">g1vec</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="n">g3vec</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="n">p1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">ReciprocalMedium</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">AdjointMedium</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        
        <span class="c1"># Inherit __init__ from Wavefield_NRM_p_w</span>
        <span class="n">Wavefield_NRM_p_w</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">nt</span><span class="p">,</span><span class="n">dt</span><span class="p">,</span><span class="n">nr</span><span class="p">,</span><span class="n">dx1</span><span class="p">,</span><span class="n">verbose</span><span class="p">)</span>
        
        <span class="c1"># Check if medium parameters are passed as arrays</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x3vec</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">avec</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bvec</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">g1vec</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">g3vec</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="p">):</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Layered_NRM_p_w: x3vec, avec, bvec, g1vec and g3vec have to be of the type numpy.ndarray.&#39;</span><span class="p">)</span>
            
        <span class="c1"># Set gamma_1 and gamma_3 by default equal to zero</span>
        <span class="k">if</span> <span class="n">g1vec</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">g1vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">avec</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">g3vec</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">g3vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">avec</span><span class="p">)</span>
            
        <span class="c1"># Force the medium parameters to have identical shape</span>
        <span class="k">if</span> <span class="n">x3vec</span><span class="o">.</span><span class="n">shape</span><span class="o">!=</span><span class="n">avec</span><span class="o">.</span><span class="n">shape</span> <span class="ow">or</span> <span class="n">x3vec</span><span class="o">.</span><span class="n">shape</span><span class="o">!=</span><span class="n">bvec</span><span class="o">.</span><span class="n">shape</span> <span class="ow">or</span> <span class="n">x3vec</span><span class="o">.</span><span class="n">shape</span><span class="o">!=</span><span class="n">g1vec</span><span class="o">.</span><span class="n">shape</span> <span class="ow">or</span> <span class="n">x3vec</span><span class="o">.</span><span class="n">shape</span><span class="o">!=</span><span class="n">g3vec</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Layered_NRM_p_w: x3vec, avec, bvec, g1vec and g3vec have to be of identical shape.&#39;</span><span class="p">)</span>
        
        <span class="c1"># Force the medium parameters to be 1-dimensional, i.e. e.g. avec.shape=(n,)</span>
        <span class="k">if</span> <span class="n">x3vec</span><span class="o">.</span><span class="n">ndim</span><span class="o">!=</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Layered_NRM_p_w: x3vec.ndim, avec.ndim, bvec.ndim, g1vec.ndim and g3vec.ndim must be one.&#39;</span><span class="p">)</span>
        
        <span class="c1"># Check if x3vec is positive and constantly increasing</span>
        <span class="k">if</span> <span class="n">x3vec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">0</span> <span class="ow">or</span> <span class="p">(</span><span class="n">x3vec</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">-</span><span class="n">x3vec</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Layered_NRM_p_w: x3vec must only contain constantly increasing values greater than, or equal to zero.&#39;</span><span class="p">)</span>
        
        <span class="c1"># Check if p1 is a scalar</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span><span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span><span class="nb">float</span><span class="p">)</span> <span class="p">):</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Layered_NRM_p_w: p1 must be of tyoe int or float.&#39;</span><span class="p">)</span>
        
        <span class="c1"># Check if Medium choices are bools</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ReciprocalMedium</span><span class="p">,</span><span class="nb">bool</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">AdjointMedium</span><span class="p">,</span><span class="nb">bool</span><span class="p">)</span> <span class="p">):</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Layered_NRM_p_w: </span><span class="se">\&#39;</span><span class="s1">ReciprocalMedium</span><span class="se">\&#39;</span><span class="s1"> and </span><span class="se">\&#39;</span><span class="s1">AdjointMedium</span><span class="se">\&#39;</span><span class="s1"> must be of the type bool.&#39;</span><span class="p">)</span>
        
        <span class="c1"># Check if medium parameters correspond to a lossless (non-)reciprocal medium</span>
        <span class="k">if</span> <span class="n">ReciprocalMedium</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">avec</span><span class="o">.</span><span class="n">imag</span><span class="o">.</span><span class="n">any</span><span class="p">()</span><span class="o">!=</span><span class="mi">0</span> <span class="ow">or</span> <span class="n">bvec</span><span class="o">.</span><span class="n">imag</span><span class="o">.</span><span class="n">any</span><span class="p">()</span><span class="o">!=</span><span class="mi">0</span> <span class="ow">or</span> <span class="n">g1vec</span><span class="o">.</span><span class="n">imag</span><span class="o">.</span><span class="n">any</span><span class="p">()</span><span class="o">!=</span><span class="mi">0</span> <span class="ow">or</span> <span class="n">g3vec</span><span class="o">.</span><span class="n">imag</span><span class="o">.</span><span class="n">any</span><span class="p">()</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Layered_NRM_p_w: In lossless non-reciprocal media the imaginary value of avec, bvec, g1vec and g3vec has to be zero.&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">ReciprocalMedium</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">avec</span><span class="o">.</span><span class="n">imag</span><span class="o">.</span><span class="n">any</span><span class="p">()</span><span class="o">!=</span><span class="mi">0</span> <span class="ow">or</span> <span class="n">bvec</span><span class="o">.</span><span class="n">imag</span><span class="o">.</span><span class="n">any</span><span class="p">()</span><span class="o">!=</span><span class="mi">0</span> <span class="ow">or</span> <span class="n">g1vec</span><span class="o">.</span><span class="n">real</span><span class="o">.</span><span class="n">any</span><span class="p">()</span><span class="o">!=</span><span class="mi">0</span> <span class="ow">or</span> <span class="n">g3vec</span><span class="o">.</span><span class="n">real</span><span class="o">.</span><span class="n">any</span><span class="p">()</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Layered_NRM_p_w: In lossless reciprocal media the imaginary value of avec and bvec has to be zero, the real value of g1vec and g3vec has to be zero.&#39;</span><span class="p">)</span>
            
        <span class="c1"># Set medium parameters </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x3vec</span> <span class="o">=</span> <span class="n">x3vec</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">avec</span> <span class="o">=</span> <span class="n">avec</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bvec</span> <span class="o">=</span> <span class="n">bvec</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">g1vec</span> <span class="o">=</span> <span class="n">g1vec</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">g3vec</span> <span class="o">=</span> <span class="n">g3vec</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p1</span> <span class="o">=</span> <span class="n">p1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ReciprocalMedium</span> <span class="o">=</span> <span class="n">ReciprocalMedium</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">AdjointMedium</span> <span class="o">=</span> <span class="n">AdjointMedium</span>
        
        <span class="c1"># Calculate vertical ray-parameter p3=p3(+p1) p3n=p3(-p1) </span>
        <span class="c1"># Note: By default python uses opposite sign convention for evanescent waves as Kees&#39;: (-1)**0.5=1j</span>
        <span class="n">p3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">avec</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
        <span class="n">p3n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">avec</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ReciprocalMedium</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">p3</span><span class="p">[:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">avec</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">bvec</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">g1vec</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">g3vec</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">p1</span><span class="o">**</span><span class="mi">2</span>
            <span class="n">p3n</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">p3</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">ReciprocalMedium</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">p3</span><span class="p">[:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">avec</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">bvec</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">g1vec</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">g1vec</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">p1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">p1</span><span class="o">**</span><span class="mi">2</span>
            <span class="n">p3n</span><span class="p">[:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">avec</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">bvec</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">g1vec</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">g1vec</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">p1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">p1</span><span class="o">**</span><span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p3</span> <span class="o">=</span> <span class="n">p3</span><span class="o">**</span><span class="mf">0.5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p3n</span> <span class="o">=</span> <span class="n">p3n</span><span class="o">**</span><span class="mf">0.5</span>
        
<div class="viewcode-block" id="Layered_NRM_p_w.L_eigenvectors_p_w"><a class="viewcode-back" href="../Layered_NRM_p_w.html#Layered_NRM_p_w.Layered_NRM_p_w.L_eigenvectors_p_w">[docs]</a>    <span class="k">def</span> <span class="nf">L_eigenvectors_p_w</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">beta</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">g3</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">p3</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">p3n</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">normalisation</span><span class="o">=</span><span class="s1">&#39;flux&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;computes the eigenvector matrix &#39;L&#39; and its inverse &#39;Linv&#39;, either in flux- or in pressure-normalisation for a single vertical ray-parameter &#39;p3&#39; inside a homogeneous layer. If \&#39;AdjointMedium=True\&#39;, **L_eigenvectors_p_w** also computes the eigenvector matrix in the adjoint medium &#39;La&#39; and its inverse &#39;Lainv&#39;.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">    </span>
<span class="sd">        beta : int, float</span>
<span class="sd">            Medium parameter :math:`\\beta`  (real-valued).</span>
<span class="sd">        </span>
<span class="sd">        g3 : int, float</span>
<span class="sd">            Medium parameter :math:`\gamma_3`.</span>
<span class="sd">        </span>
<span class="sd">        p3 : int, float</span>
<span class="sd">            Vertical ray-parameter :math:`p_3` for a positive horizontal ray-parameter :math:`p_1`.</span>
<span class="sd">        </span>
<span class="sd">        p3n : int, float, optional (required if &#39;AdjointMedium=True&#39;)</span>
<span class="sd">            Vertical ray-parameter :math:`p_3` for a negative horizontal ray-parameter :math:`p_1`.</span>
<span class="sd">            </span>
<span class="sd">        normalisation : str, optional</span>
<span class="sd">            For pressure-normalisation set normalisation=&#39;pressure&#39;, for flux-normalisation set normalisation=&#39;flux&#39;.</span>
<span class="sd">            </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">    </span>
<span class="sd">        dict</span>
<span class="sd">            Dictionary that contains </span>
<span class="sd">                - **L**: The eigenvector matrix.</span>
<span class="sd">                - **Linv**: The inverse of the eigenvector matrix.</span>
<span class="sd">                - **La**: The eigenvector matrix (adjoint medium).</span>
<span class="sd">                - **Lainv**: The inverse of the eigenvector matrix (adjoint medium).</span>
<span class="sd">            All eigenvector matrices are stored in a in a (2x2)-array. </span>
<span class="sd">        </span>
<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">            - The eigenvector matrix &#39;L&#39; and its inverse &#39;Linv&#39; are different for reciprocal and non-reciprocal media.</span>
<span class="sd">            - For reciprocal media, the eigenvectors of the adjoint medium are identical to the eigenvectors of the true medium.</span>
<span class="sd">            - We have defined the eigenvectors of the adjoint medium only for flux-normalisation.</span>
<span class="sd">        </span>
<span class="sd">        References</span>
<span class="sd">        ----------</span>
<span class="sd">        Kees document as soon as it is published.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>

<span class="sd">        &gt;&gt;&gt; from Layered_NRM_p_w import Layered_NRM_p_w as LM</span>
<span class="sd">        &gt;&gt;&gt; import numpy as np</span>
<span class="sd">        </span>
<span class="sd">        &gt;&gt;&gt; # Initialise wavefield in a layered non-reciprocal medium</span>
<span class="sd">        &gt;&gt;&gt; F=LM( nt=1024 , dt=0.005 , x3vec=np.array([1.1,2.2,3.7]) , avec=np.array([1,2,3]) , bvec=np.array([0.4,3.14,2]) , g1vec=np.array([0.9,2.1,0.3]) , g3vec=np.array([0.7,1.14,0.2]) , p1=2e-4 , ReciprocalMedium=False )</span>
<span class="sd">        </span>
<span class="sd">        &gt;&gt;&gt; # Compute eigenvectors in flux-normalisation</span>
<span class="sd">        &gt;&gt;&gt; Lvecs=F.L_eigenvectors_p_w(beta=0.1,g3=0.4,p3=2e-4,normalisation=&#39;flux&#39;)</span>
<span class="sd">        </span>
<span class="sd">        &gt;&gt;&gt; # Eigenvector matrix</span>
<span class="sd">        &gt;&gt;&gt; L = Lvecs[&#39;L&#39;]</span>
<span class="sd">        ([[15.8113883 +0.j, 15.8113883 +0.j],[ 0.03162278+0.j, -0.03162278+0.j]])</span>
<span class="sd">        </span>
<span class="sd">        &gt;&gt;&gt; # Inverse eigenvector matrix</span>
<span class="sd">        &gt;&gt;&gt; Linv = Lvecs[&#39;Linv&#39;]</span>
<span class="sd">        ([[  0.03162278+0.j,  15.8113883 +0.j],[  0.03162278+0.j, -15.8113883 -0.j]])</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check if required input variables are given</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">beta</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">g3</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">p3</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;L_eigenvectors_p_w: The input variables </span><span class="se">\&#39;</span><span class="s1">beta</span><span class="se">\&#39;</span><span class="s1">, </span><span class="se">\&#39;</span><span class="s1">g3</span><span class="se">\&#39;</span><span class="s1"> and  </span><span class="se">\&#39;</span><span class="s1">p3</span><span class="se">\&#39;</span><span class="s1"> must be set.&#39;</span><span class="p">)</span>
         
        <span class="c1"># Check if normalisation is set correctly</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">normalisation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="s1">&#39;flux&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">normalisation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="s1">&#39;pressure&#39;</span><span class="p">):</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;L_eigenvectors_p_w: The input variable </span><span class="se">\&#39;</span><span class="s1">normalisation</span><span class="se">\&#39;</span><span class="s1"> must be set, either to </span><span class="se">\&#39;</span><span class="s1">flux</span><span class="se">\&#39;</span><span class="s1">, or to </span><span class="se">\&#39;</span><span class="s1">pressure</span><span class="se">\&#39;</span><span class="s1">.&#39;</span><span class="p">)</span>
            
        <span class="c1"># Check if the vertical ray-parameter for a negative horizontal ray-parameter is given</span>
        <span class="k">if</span>  <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">AdjointMedium</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">p3n</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">normalisation</span> <span class="ow">is</span> <span class="s1">&#39;flux&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ReciprocalMedium</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">):</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;L_eigenvectors_p_w: The input variable </span><span class="se">\&#39;</span><span class="s1">p3n</span><span class="se">\&#39;</span><span class="s1"> (vertical ray-parameter p3 for a negative horizontal ray-parameter p1) must be given to compute the eigenvector matrix of the adjoint medium </span><span class="se">\&#39;</span><span class="s1">La</span><span class="se">\&#39;</span><span class="s1"> and its inverse</span><span class="se">\&#39;</span><span class="s1">Lainv</span><span class="se">\&#39;</span><span class="s1">.&#39;</span><span class="p">)</span>
            
        <span class="c1"># Initialise L and Linv</span>
        <span class="n">L</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
        <span class="n">Linv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
        <span class="n">La</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">Lainv</span> <span class="o">=</span> <span class="kc">None</span>
            
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ReciprocalMedium</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">normalisation</span> <span class="ow">is</span> <span class="s1">&#39;flux&#39;</span><span class="p">):</span>
            <span class="c1"># L matrix</span>
            <span class="n">L</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">L</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">L</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">p3</span><span class="o">+</span><span class="n">g3</span><span class="p">)</span><span class="o">/</span><span class="n">beta</span>
            <span class="n">L</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">p3</span><span class="o">-</span><span class="n">g3</span><span class="p">)</span><span class="o">/</span><span class="n">beta</span>
            <span class="n">L</span> <span class="o">=</span> <span class="p">(</span><span class="n">beta</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">p3</span><span class="p">))</span><span class="o">**</span><span class="mf">0.5</span><span class="o">*</span><span class="n">L</span>
            
            <span class="c1"># Inverse L matrix</span>
            <span class="n">Linv</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">L</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">Linv</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">L</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">Linv</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">L</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">Linv</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">L</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">AdjointMedium</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">L_eigenvectors_p_w (AdjointMedium is True) and (ReciprocalMedium is True)&#39;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;---------------------------------------------------------------------------&#39;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;For reciprocal media, the eigenvector matrix of a medium and its adjoint medium are identical.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
               
                <span class="n">La</span> <span class="o">=</span> <span class="n">L</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">Lainv</span> <span class="o">=</span> <span class="n">Linv</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            
        <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ReciprocalMedium</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">normalisation</span> <span class="ow">is</span> <span class="s1">&#39;pressure&#39;</span><span class="p">):</span>            
            <span class="c1"># L matrix</span>
            <span class="n">L</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">L</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">L</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">p3</span><span class="o">+</span><span class="n">g3</span><span class="p">)</span><span class="o">/</span><span class="n">beta</span>
            <span class="n">L</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">p3</span><span class="o">-</span><span class="n">g3</span><span class="p">)</span><span class="o">/</span><span class="n">beta</span>
            
            <span class="c1"># Inverse L matrix</span>
            <span class="n">Linv</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">L</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">Linv</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">Linv</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">L</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">Linv</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">Linv</span> <span class="o">=</span> <span class="n">beta</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">p3</span><span class="p">)</span><span class="o">*</span><span class="n">Linv</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">AdjointMedium</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">L_eigenvectors_p_w (AdjointMedium is True) and (normalisation=</span><span class="se">\&#39;</span><span class="s1">pressure</span><span class="se">\&#39;</span><span class="s1">)&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-----------------------------------------------------------------------------&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;We have defined the eigenvector matrix of the adjoint medium </span><span class="se">\&#39;</span><span class="s1">La</span><span class="se">\&#39;</span><span class="s1"> and its inverse </span><span class="se">\&#39;</span><span class="s1">Lainv</span><span class="se">\&#39;</span><span class="s1"> only for flux-normalisation.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            
        <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ReciprocalMedium</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">normalisation</span> <span class="ow">is</span> <span class="s1">&#39;flux&#39;</span><span class="p">):</span>
            <span class="c1"># L matrix</span>
            <span class="n">L</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">beta</span><span class="o">/</span><span class="n">p3</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span>
            <span class="n">L</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">L</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">L</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">p3</span><span class="o">/</span><span class="n">beta</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span>
            <span class="n">L</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">L</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">L</span> <span class="o">=</span> <span class="n">L</span><span class="o">/</span><span class="mi">2</span><span class="o">**</span><span class="mf">0.5</span>
            
            <span class="c1"># Inverse L matrix</span>
            <span class="n">Linv</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">L</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">Linv</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">L</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">Linv</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">L</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">Linv</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">L</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">AdjointMedium</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">L_eigenvectors_p_w (AdjointMedium is True) and (ReciprocalMedium is False)&#39;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;----------------------------------------------------------------------------&#39;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;For non-reciprocal media, the eigenvector matrix of a medium and its adjoint medium are different.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                
                <span class="c1"># L matrix (adjoint medium) = N Transpose( Inverse( L(-p1) )) N</span>
                <span class="n">La</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
                <span class="n">La</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">beta</span><span class="o">/</span><span class="n">p3n</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span>
                <span class="n">La</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">La</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">La</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">p3n</span><span class="o">/</span><span class="n">beta</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span>
                <span class="n">La</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">La</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">La</span> <span class="o">=</span> <span class="n">La</span><span class="o">/</span><span class="mi">2</span><span class="o">**</span><span class="mf">0.5</span>
                
                <span class="c1">#  Inverse L matrix (adjoint medium) = N Transpose( L(-p1)) N</span>
                <span class="n">Lainv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
                <span class="n">Lainv</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">p3n</span><span class="o">/</span><span class="n">beta</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span>
                <span class="n">Lainv</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">beta</span><span class="o">/</span><span class="n">p3n</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span>
                <span class="n">Lainv</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">Lainv</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">Lainv</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">Lainv</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">Lainv</span> <span class="o">=</span> <span class="n">Lainv</span><span class="o">/</span><span class="mi">2</span><span class="o">**</span><span class="mf">0.5</span>
            
        <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ReciprocalMedium</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">normalisation</span> <span class="ow">is</span> <span class="s1">&#39;pressure&#39;</span><span class="p">):</span>
            <span class="c1"># L matrix</span>
            <span class="n">L</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">L</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">L</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">p3</span><span class="o">/</span><span class="n">beta</span>
            <span class="n">L</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">p3</span><span class="o">/</span><span class="n">beta</span>
            
            <span class="c1"># Inverse L matrix</span>
            <span class="n">Linv</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">Linv</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">beta</span><span class="o">/</span><span class="n">p3</span>
            <span class="n">Linv</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">Linv</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">beta</span><span class="o">/</span><span class="n">p3</span>
            <span class="n">Linv</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">Linv</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">AdjointMedium</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">L_eigenvectors_p_w (AdjointMedium is True) and (normalisation=</span><span class="se">\&#39;</span><span class="s1">pressure</span><span class="se">\&#39;</span><span class="s1">)&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-----------------------------------------------------------------------------&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;We have defined the eigenvector matrix of the adjoint medium </span><span class="se">\&#39;</span><span class="s1">La</span><span class="se">\&#39;</span><span class="s1"> and its inverse </span><span class="se">\&#39;</span><span class="s1">Lainv</span><span class="se">\&#39;</span><span class="s1"> only for flux-normalisation.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        
        <span class="n">out</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;L&#39;</span><span class="p">:</span><span class="n">L</span><span class="p">,</span><span class="s1">&#39;Linv&#39;</span><span class="p">:</span><span class="n">Linv</span><span class="p">,</span><span class="s1">&#39;La&#39;</span><span class="p">:</span><span class="n">La</span><span class="p">,</span><span class="s1">&#39;Lainv&#39;</span><span class="p">:</span><span class="n">Lainv</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">out</span></div>
          
<div class="viewcode-block" id="Layered_NRM_p_w.RT_p_w"><a class="viewcode-back" href="../Layered_NRM_p_w.html#Layered_NRM_p_w.Layered_NRM_p_w.RT_p_w">[docs]</a>    <span class="k">def</span> <span class="nf">RT_p_w</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">beta_u</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">g3_u</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">p3_u</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">p3n_u</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">beta_l</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">g3_l</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">p3_l</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">p3n_l</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">normalisation</span><span class="o">=</span><span class="s1">&#39;flux&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;computes the scattering coefficients at an horizontal interface, either in flux- or in pressure-normalisation. The variables with subscript &#39;u&#39; refer to the medium parameters in the upper half-space, the variables with subscript &#39;l&#39; refer to the medium parameters in the lower half-space. We consider a single horizontal ray-parameter :math:`p_1`, which is associated with a vertical ray-parameter &#39;p3_u&#39; in the upper half-space and &#39;p3_l&#39; in the lower half-space. If one sets \&#39;AdjointMedium=True\&#39;, **RT_p_w** also computes the scattering coefficients in the adjoint medium.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">    </span>
<span class="sd">        beta_u : int, float</span>
<span class="sd">            Medium parameter :math:`\\beta` (real-valued) (upper half-space).</span>
<span class="sd">        </span>
<span class="sd">        g3_u : int, float</span>
<span class="sd">            Medium parameter :math:`\gamma_3` (upper half-space).</span>
<span class="sd">        </span>
<span class="sd">        p3_u : int, float</span>
<span class="sd">            Vertical ray-parameter :math:`p_3` for a positive horizontal ray-parameter :math:`p_1` (upper half-space).</span>
<span class="sd">        </span>
<span class="sd">        p3n_u : int, float, optional (required if &#39;AdjointMedium=True&#39;)</span>
<span class="sd">            Vertical ray-parameter :math:`p_3` for a negative horizontal ray-parameter :math:`p_1` (upper half-space).</span>
<span class="sd">            </span>
<span class="sd">        beta_l : int, float</span>
<span class="sd">            Medium parameter :math:`\\beta` (real-valued) (lower half-space).</span>
<span class="sd">        </span>
<span class="sd">        g3_l : int, float</span>
<span class="sd">            Medium parameter :math:`\gamma_3` (lower half-space).</span>
<span class="sd">        </span>
<span class="sd">        p3_l : int, float</span>
<span class="sd">            Vertical ray-parameter :math:`p_3` for a positive horizontal ray-parameter :math:`p_1` (lower half-space).</span>
<span class="sd">        </span>
<span class="sd">        p3n_l : int, float, optional (required if &#39;AdjointMedium=True&#39;)</span>
<span class="sd">            Vertical ray-parameter :math:`p_3` for a negative horizontal ray-parameter :math:`p_1` (lower half-space).</span>
<span class="sd">            </span>
<span class="sd">        normalisation : str, optional</span>
<span class="sd">            For pressure-normalisation set normalisation=&#39;pressure&#39;, for flux-normalisation set normalisation=&#39;flux&#39;.</span>
<span class="sd">            </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">    </span>
<span class="sd">        dict</span>
<span class="sd">            Dictionary that contains </span>
<span class="sd">                - **rP**: Reflection coefficient from above.</span>
<span class="sd">                - **tP**: Transmission coefficient from above &#39;tP&#39;.</span>
<span class="sd">                - **rM**: Reflection coefficient from below.</span>
<span class="sd">                - **tM**: Transmission coefficient from below.</span>
<span class="sd">                - **rPa**: Reflection coefficient from above (adjoint medium).</span>
<span class="sd">                - **tPa**: Transmission coefficient from above (adjoint medium).</span>
<span class="sd">                - **rMa**: Reflection coefficient from below (adjoint medium).</span>
<span class="sd">                - **tMa**: Transmission coefficient from below (adjoint medium).</span>
<span class="sd">            All scattering coefficients are stored as scalars.</span>
<span class="sd">        </span>
<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">    </span>
<span class="sd">        - For reciprocal media, the scattering coefficients of the adjoint medium are identical to the scattering coefficients of the true medium.</span>
<span class="sd">        - We have defined the scattering coefficients of the adjoint medium only for flux-normalisation.</span>
<span class="sd">            </span>
<span class="sd">        References</span>
<span class="sd">        ----------</span>
<span class="sd">        Kees document as soon as it is published.</span>
<span class="sd">        </span>
<span class="sd">        Examples</span>
<span class="sd">        --------</span>

<span class="sd">        &gt;&gt;&gt; from Layered_NRM_p_w import Layered_NRM_p_w as LM</span>
<span class="sd">        &gt;&gt;&gt; import numpy as np</span>
<span class="sd">        </span>
<span class="sd">        &gt;&gt;&gt; # Create wavefield F for positive horizontal ray-parameter p1</span>
<span class="sd">        &gt;&gt;&gt; F=LM(nt=1024,dt=0.005,x3vec=np.array([1.1,2.2,3.7]),avec=np.array([1,2,3]),bvec=np.array([0.4,3.14,2]),g1vec=np.array([0.9,2.1,0.3]),g3vec=np.array([0.7,1.14,0.2]),p1=2e-4,ReciprocalMedium=False,AdjointMedium=True)</span>
<span class="sd">        &gt;&gt;&gt; ScatCoeffs = F.RT_p_w(beta_u=F.bvec[0],g3_u=F.g3vec[0],p3_u=F.p3[0],p3n_u=F.p3n[0],beta_l=F.bvec[1],g3_l=F.g3vec[1],p3_l=F.p3[1],p3n_l=F.p3n[1],normalisation=&#39;flux&#39;)</span>
<span class="sd">        &gt;&gt;&gt; rplus = ScatCoeffs[&#39;rP&#39;]</span>
<span class="sd">        (0.8620013269525346+0.5069060192304582j)</span>
<span class="sd">        </span>
<span class="sd">        &gt;&gt;&gt; # Create wavefield Fn for negative horizontal ray-parameter p1</span>
<span class="sd">        &gt;&gt;&gt; Fn=LM(nt=1024,dt=0.005,x3vec=np.array([1.1,2.2,3.7]),avec=np.array([1,2,3]),bvec=np.array([0.4,3.14,2]),g1vec=np.array([0.9,2.1,0.3]),g3vec=np.array([0.7,1.14,0.2]),p1=-2e-4,ReciprocalMedium=False,AdjointMedium=True)</span>
<span class="sd">        &gt;&gt;&gt; ScatCoeffsn = Fn.RT_p_w(beta_u=Fn.bvec[0],g3_u=Fn.g3vec[0],p3_u=Fn.p3[0],p3n_u=Fn.p3n[0],beta_l=Fn.bvec[1],g3_l=Fn.g3vec[1],p3_l=Fn.p3[1],p3n_l=Fn.p3n[1],normalisation=&#39;flux&#39;)</span>
<span class="sd">        </span>
<span class="sd">        &gt;&gt;&gt; # In non-reciprocal media, for flux-normalisation, the reflection coefficients</span>
<span class="sd">        &gt;&gt;&gt; # in true medium for positive horizontal ray-parameter p1</span>
<span class="sd">        &gt;&gt;&gt; # and in adjoint medium for negative horizontal ray-parameter p1</span>
<span class="sd">        &gt;&gt;&gt; # are identical:</span>
<span class="sd">        &gt;&gt;&gt; np.abs(ScatCoeffs[&#39;rP&#39;]-ScatCoeffsn[&#39;rPa&#39;])</span>
<span class="sd">        0.0</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="c1"># Check if required input variables are given</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">beta_u</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">g3_u</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">p3_u</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">beta_l</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">g3_l</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">p3_l</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;RT_p_w: The input variables </span><span class="se">\&#39;</span><span class="s1">beta_u</span><span class="se">\&#39;</span><span class="s1">, </span><span class="se">\&#39;</span><span class="s1">g3_u</span><span class="se">\&#39;</span><span class="s1">,  </span><span class="se">\&#39;</span><span class="s1">p3_u</span><span class="se">\&#39;</span><span class="s1">, </span><span class="se">\&#39;</span><span class="s1">beta_l</span><span class="se">\&#39;</span><span class="s1">, </span><span class="se">\&#39;</span><span class="s1">g3_l</span><span class="se">\&#39;</span><span class="s1">,  </span><span class="se">\&#39;</span><span class="s1">p3_l</span><span class="se">\&#39;</span><span class="s1"> must be set.&#39;</span><span class="p">)</span>
            
        <span class="c1"># Check if normalisation is set correctly</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">normalisation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="s1">&#39;flux&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">normalisation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="s1">&#39;pressure&#39;</span><span class="p">):</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;RT_p_w: The input variable </span><span class="se">\&#39;</span><span class="s1">normalisation</span><span class="se">\&#39;</span><span class="s1"> must be set, either to </span><span class="se">\&#39;</span><span class="s1">flux</span><span class="se">\&#39;</span><span class="s1">, or to </span><span class="se">\&#39;</span><span class="s1">pressure</span><span class="se">\&#39;</span><span class="s1">.&#39;</span><span class="p">)</span>
            
        <span class="c1"># Check if the vertical ray-parameter for a negative horizontal ray-parameter is given</span>
        <span class="k">if</span>  <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">AdjointMedium</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">)</span> <span class="ow">and</span> <span class="p">((</span><span class="n">p3n_u</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">p3n_l</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">))</span> <span class="ow">and</span> <span class="p">(</span><span class="n">normalisation</span> <span class="ow">is</span> <span class="s1">&#39;flux&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ReciprocalMedium</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">):</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;RT_p_w: The input variables </span><span class="se">\&#39;</span><span class="s1">p3n_u</span><span class="se">\&#39;</span><span class="s1"> and </span><span class="se">\&#39;</span><span class="s1">p3n_l</span><span class="se">\&#39;</span><span class="s1"> (vertical ray-parameter p3 for a negative horizontal ray-parameter p1) must be set to compute the scattering coefficients in the adjoint medium </span><span class="se">\&#39;</span><span class="s1">rPa</span><span class="se">\&#39;</span><span class="s1">, </span><span class="se">\&#39;</span><span class="s1">tPa</span><span class="se">\&#39;</span><span class="s1">, </span><span class="se">\&#39;</span><span class="s1">rMa</span><span class="se">\&#39;</span><span class="s1"> and </span><span class="se">\&#39;</span><span class="s1">tMa</span><span class="se">\&#39;</span><span class="s1">.&#39;</span><span class="p">)</span>
            
        <span class="c1"># Initialise scattering coefficients in adjoint medium    </span>
        <span class="n">rPa</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">tPa</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">rMa</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">tMa</span> <span class="o">=</span> <span class="kc">None</span>
            
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ReciprocalMedium</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">normalisation</span> <span class="ow">is</span> <span class="s1">&#39;flux&#39;</span><span class="p">):</span>
            
            <span class="c1"># True medium</span>
            <span class="n">rP</span> <span class="o">=</span>  <span class="p">(</span> <span class="p">(</span><span class="n">p3_u</span><span class="o">+</span><span class="n">g3_u</span><span class="p">)</span><span class="o">*</span><span class="n">beta_l</span> <span class="o">-</span> <span class="p">(</span><span class="n">p3_l</span><span class="o">+</span><span class="n">g3_l</span><span class="p">)</span><span class="o">*</span><span class="n">beta_u</span> <span class="p">)</span> <span class="o">/</span> <span class="p">(</span> <span class="p">(</span><span class="n">p3_u</span><span class="o">-</span><span class="n">g3_u</span><span class="p">)</span><span class="o">*</span><span class="n">beta_l</span> <span class="o">+</span> <span class="p">(</span><span class="n">p3_l</span><span class="o">+</span><span class="n">g3_l</span><span class="p">)</span><span class="o">*</span><span class="n">beta_u</span> <span class="p">)</span>
            <span class="n">rM</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span> <span class="p">(</span><span class="n">p3_u</span><span class="o">-</span><span class="n">g3_u</span><span class="p">)</span><span class="o">*</span><span class="n">beta_l</span> <span class="o">-</span> <span class="p">(</span><span class="n">p3_l</span><span class="o">-</span><span class="n">g3_l</span><span class="p">)</span><span class="o">*</span><span class="n">beta_u</span> <span class="p">)</span> <span class="o">/</span> <span class="p">(</span> <span class="p">(</span><span class="n">p3_u</span><span class="o">-</span><span class="n">g3_u</span><span class="p">)</span><span class="o">*</span><span class="n">beta_l</span> <span class="o">+</span> <span class="p">(</span><span class="n">p3_l</span><span class="o">+</span><span class="n">g3_l</span><span class="p">)</span><span class="o">*</span><span class="n">beta_u</span> <span class="p">)</span>
            <span class="n">tP</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">p3_u</span><span class="o">*</span><span class="n">beta_l</span><span class="o">*</span><span class="n">p3_l</span><span class="o">*</span><span class="n">beta_u</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span> <span class="o">/</span> <span class="p">(</span> <span class="p">(</span><span class="n">p3_u</span><span class="o">-</span><span class="n">g3_u</span><span class="p">)</span><span class="o">*</span><span class="n">beta_l</span> <span class="o">+</span> <span class="p">(</span><span class="n">p3_l</span><span class="o">+</span><span class="n">g3_l</span><span class="p">)</span><span class="o">*</span><span class="n">beta_u</span> <span class="p">)</span>
            <span class="n">tM</span> <span class="o">=</span> <span class="n">tP</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">AdjointMedium</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="c1"># Adjoint medium</span>
                <span class="n">rPa</span> <span class="o">=</span> <span class="n">rP</span> 
                <span class="n">tPa</span> <span class="o">=</span> <span class="n">tP</span> 
                <span class="n">rMa</span> <span class="o">=</span> <span class="n">rM</span> 
                <span class="n">tMa</span> <span class="o">=</span> <span class="n">tM</span> 
    
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">RT_p_w: (AdjointMedium is True) and (ReciprocalMedium is True)&#39;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;----------------------------------------------------------------&#39;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;For reciprocal media, the scattering coefficients in a medium and its adjoint medium are identical.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        
        <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ReciprocalMedium</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">normalisation</span> <span class="ow">is</span> <span class="s1">&#39;pressure&#39;</span><span class="p">):</span>
            
            <span class="c1"># True medium</span>
            <span class="n">rP</span> <span class="o">=</span>  <span class="p">(</span> <span class="p">(</span><span class="n">p3_u</span><span class="o">+</span><span class="n">g3_u</span><span class="p">)</span><span class="o">*</span><span class="n">beta_l</span> <span class="o">-</span> <span class="p">(</span><span class="n">p3_l</span><span class="o">+</span><span class="n">g3_l</span><span class="p">)</span><span class="o">*</span><span class="n">beta_u</span> <span class="p">)</span> <span class="o">/</span> <span class="p">(</span> <span class="p">(</span><span class="n">p3_u</span><span class="o">-</span><span class="n">g3_u</span><span class="p">)</span><span class="o">*</span><span class="n">beta_l</span> <span class="o">+</span> <span class="p">(</span><span class="n">p3_l</span><span class="o">+</span><span class="n">g3_l</span><span class="p">)</span><span class="o">*</span><span class="n">beta_u</span> <span class="p">)</span>
            <span class="n">tP</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">p3_u</span><span class="o">*</span><span class="n">beta_l</span> <span class="o">/</span> <span class="p">(</span> <span class="p">(</span><span class="n">p3_u</span><span class="o">-</span><span class="n">g3_u</span><span class="p">)</span><span class="o">*</span><span class="n">beta_l</span> <span class="o">+</span> <span class="p">(</span><span class="n">p3_l</span><span class="o">+</span><span class="n">g3_l</span><span class="p">)</span><span class="o">*</span><span class="n">beta_u</span> <span class="p">)</span>
            <span class="n">rM</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span> <span class="p">(</span><span class="n">p3_u</span><span class="o">-</span><span class="n">g3_u</span><span class="p">)</span><span class="o">*</span><span class="n">beta_l</span> <span class="o">-</span> <span class="p">(</span><span class="n">p3_l</span><span class="o">-</span><span class="n">g3_l</span><span class="p">)</span><span class="o">*</span><span class="n">beta_u</span> <span class="p">)</span> <span class="o">/</span> <span class="p">(</span> <span class="p">(</span><span class="n">p3_u</span><span class="o">-</span><span class="n">g3_u</span><span class="p">)</span><span class="o">*</span><span class="n">beta_l</span> <span class="o">+</span> <span class="p">(</span><span class="n">p3_l</span><span class="o">+</span><span class="n">g3_l</span><span class="p">)</span><span class="o">*</span><span class="n">beta_u</span> <span class="p">)</span>
            <span class="n">tM</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">p3_l</span><span class="o">*</span><span class="n">beta_u</span> <span class="o">/</span> <span class="p">(</span> <span class="p">(</span><span class="n">p3_u</span><span class="o">-</span><span class="n">g3_u</span><span class="p">)</span><span class="o">*</span><span class="n">beta_l</span> <span class="o">+</span> <span class="p">(</span><span class="n">p3_l</span><span class="o">+</span><span class="n">g3_l</span><span class="p">)</span><span class="o">*</span><span class="n">beta_u</span> <span class="p">)</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">AdjointMedium</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">RT_p_w: (AdjointMedium is True) and (normalisation=</span><span class="se">\&#39;</span><span class="s1">pressure</span><span class="se">\&#39;</span><span class="s1">)&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;------------------------------------------------------------------&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;We have defined the scattering coefficients of the adjoint medium only for flux-normalisation.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            
        <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ReciprocalMedium</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">normalisation</span> <span class="ow">is</span> <span class="s1">&#39;flux&#39;</span><span class="p">):</span>
            
            <span class="c1"># True medium</span>
            <span class="n">rP</span> <span class="o">=</span> <span class="p">(</span><span class="n">p3_u</span><span class="o">*</span><span class="n">beta_l</span> <span class="o">-</span> <span class="n">p3_l</span><span class="o">*</span><span class="n">beta_u</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">p3_u</span><span class="o">*</span><span class="n">beta_l</span> <span class="o">+</span> <span class="n">p3_l</span><span class="o">*</span><span class="n">beta_u</span><span class="p">)</span>
            <span class="n">tP</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">p3_u</span><span class="o">*</span><span class="n">beta_l</span><span class="o">*</span><span class="n">p3_l</span><span class="o">*</span><span class="n">beta_u</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span> <span class="o">/</span> <span class="p">(</span><span class="n">p3_u</span><span class="o">*</span><span class="n">beta_l</span> <span class="o">+</span> <span class="n">p3_l</span><span class="o">*</span><span class="n">beta_u</span><span class="p">)</span>
            <span class="n">rM</span> <span class="o">=</span> <span class="o">-</span><span class="n">rP</span>
            <span class="n">tM</span> <span class="o">=</span> <span class="n">tP</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">AdjointMedium</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="c1"># Adjoint medium</span>
                <span class="n">rPa</span> <span class="o">=</span> <span class="p">(</span><span class="n">p3n_u</span><span class="o">*</span><span class="n">beta_l</span> <span class="o">-</span> <span class="n">p3n_l</span><span class="o">*</span><span class="n">beta_u</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">p3n_u</span><span class="o">*</span><span class="n">beta_l</span> <span class="o">+</span> <span class="n">p3n_l</span><span class="o">*</span><span class="n">beta_u</span><span class="p">)</span>
                <span class="n">tPa</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">p3n_u</span><span class="o">*</span><span class="n">beta_l</span><span class="o">*</span><span class="n">p3n_l</span><span class="o">*</span><span class="n">beta_u</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span> <span class="o">/</span> <span class="p">(</span><span class="n">p3n_u</span><span class="o">*</span><span class="n">beta_l</span> <span class="o">+</span> <span class="n">p3n_l</span><span class="o">*</span><span class="n">beta_u</span><span class="p">)</span>
                <span class="n">rMa</span> <span class="o">=</span> <span class="o">-</span><span class="n">rPa</span>
                <span class="n">tMa</span> <span class="o">=</span> <span class="n">tPa</span> 
            
        <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ReciprocalMedium</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">normalisation</span> <span class="ow">is</span> <span class="s1">&#39;pressure&#39;</span><span class="p">):</span>
            <span class="n">rP</span> <span class="o">=</span> <span class="p">(</span><span class="n">p3_u</span><span class="o">*</span><span class="n">beta_l</span> <span class="o">-</span> <span class="n">p3_l</span><span class="o">*</span><span class="n">beta_u</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">p3_u</span><span class="o">*</span><span class="n">beta_l</span> <span class="o">+</span> <span class="n">p3_l</span><span class="o">*</span><span class="n">beta_u</span><span class="p">)</span>
            <span class="n">tP</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">p3_u</span><span class="o">*</span><span class="n">beta_l</span> <span class="o">/</span> <span class="p">(</span><span class="n">p3_u</span><span class="o">*</span><span class="n">beta_l</span> <span class="o">+</span> <span class="n">p3_l</span><span class="o">*</span><span class="n">beta_u</span><span class="p">)</span>
            <span class="n">rM</span> <span class="o">=</span> <span class="o">-</span><span class="n">rP</span>
            <span class="n">tM</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">p3_l</span><span class="o">*</span><span class="n">beta_u</span> <span class="o">/</span> <span class="p">(</span><span class="n">p3_u</span><span class="o">*</span><span class="n">beta_l</span> <span class="o">+</span> <span class="n">p3_l</span><span class="o">*</span><span class="n">beta_u</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">AdjointMedium</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">RT_p_w: (AdjointMedium is True) and (normalisation=</span><span class="se">\&#39;</span><span class="s1">pressure</span><span class="se">\&#39;</span><span class="s1">)&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;------------------------------------------------------------------&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;We have defined the scattering coefficients of the adjoint medium only for flux-normalisation.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            
        <span class="n">out</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;rP&#39;</span><span class="p">:</span><span class="n">rP</span><span class="p">,</span><span class="s1">&#39;tP&#39;</span><span class="p">:</span><span class="n">tP</span><span class="p">,</span><span class="s1">&#39;rM&#39;</span><span class="p">:</span><span class="n">rM</span><span class="p">,</span><span class="s1">&#39;tM&#39;</span><span class="p">:</span><span class="n">tM</span><span class="p">,</span><span class="s1">&#39;rPa&#39;</span><span class="p">:</span><span class="n">rPa</span><span class="p">,</span><span class="s1">&#39;tPa&#39;</span><span class="p">:</span><span class="n">tPa</span><span class="p">,</span><span class="s1">&#39;rMa&#39;</span><span class="p">:</span><span class="n">rMa</span><span class="p">,</span><span class="s1">&#39;tMa&#39;</span><span class="p">:</span><span class="n">tMa</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">out</span></div>
    
<div class="viewcode-block" id="Layered_NRM_p_w.W_propagators_p_w"><a class="viewcode-back" href="../Layered_NRM_p_w.html#Layered_NRM_p_w.Layered_NRM_p_w.W_propagators_p_w">[docs]</a>    <span class="k">def</span> <span class="nf">W_propagators_p_w</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p3</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">p3n</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">g3</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">dx3</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">w</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;computes the downgoing propagator &#39;wP&#39; and the upgoing progagator &#39;wM&#39; for a single vertical ray-parameter &#39;p3&#39; and a vertical distance &#39;dx3&#39; (downward pointing :math:`x_3`-axis).</span>
<span class="sd">        </span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">    </span>
<span class="sd">        p3 : int, float</span>
<span class="sd">            Vertical ray-parameter :math:`p_3` for a positive horizontal ray-parameter :math:`p_1`.</span>
<span class="sd">        </span>
<span class="sd">        p3n : int, float, optional (required if &#39;AdjointMedium=True&#39;)</span>
<span class="sd">            Vertical ray-parameter :math:`p_3` for a negative horizontal ray-parameter :math:`p_1`.</span>
<span class="sd">            </span>
<span class="sd">        g3 : int, float</span>
<span class="sd">            Medium parameter :math:`\gamma_3`.</span>
<span class="sd">            </span>
<span class="sd">        dx3 : int, float</span>
<span class="sd">            Vertical propagation distance :math:`\Delta x_3` (downward pointing :math:`x_3`-axis).</span>
<span class="sd">            </span>
<span class="sd">        w : int, float, optional</span>
<span class="sd">            Frequency :math:`\omega` in radians. By default the propagators are computed for all sampled (positive) frequencies.</span>
<span class="sd">        </span>
<span class="sd">            </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">    </span>
<span class="sd">        dict</span>
<span class="sd">            Dictionary that contains </span>
<span class="sd">                - **wP**: Downward propagator :math:`\\tilde{w}^+`.</span>
<span class="sd">                - **wM**: Upward propagator :math:`\\tilde{w}^-`.</span>
<span class="sd">                - **wPa**: Downward propagator :math:`\\tilde{w}^{+(a)}` (adjoint medium). </span>
<span class="sd">                - **wMa**: Upward propagator :math:`\\tilde{w}^{-(a)}` (adjoint medium). </span>
<span class="sd">            All propagators are stored either in an arrays of shape (nf,1), or as a scalar (if the variable&#39;w&#39; is set). The variables &#39;wPa&#39; and &#39;wMa&#39; are computed only if one sets &#39;AdjointMedium=True&#39;.</span>
<span class="sd">        </span>
<span class="sd">        </span>
<span class="sd">        References</span>
<span class="sd">        ----------</span>
<span class="sd">        Kees document as soon as it is published.</span>


<span class="sd">        Examples</span>
<span class="sd">        --------</span>

<span class="sd">        &gt;&gt;&gt; from Layered_NRM_p_w import Layered_NRM_p_w as LM</span>
<span class="sd">        &gt;&gt;&gt; import numpy as np</span>
<span class="sd">        </span>
<span class="sd">        &gt;&gt;&gt; F=LM(nt=1024,dt=0.005,x3vec=np.array([1.1,2.2,3.7]),avec=np.array([1,2,3]),bvec=np.array([0.4,3.14,2]),g1vec=np.array([0.9,2.1,0.3]),g3vec=np.array([0.7,1.14,0.2]),p1=2e-4,ReciprocalMedium=False)</span>
<span class="sd">        &gt;&gt;&gt; W=F.W_propagators_p_w( p3=F.p3[0] , p3n=F.p3n[0] , g3=F.g3vec[0] , dx3=F.x3vec[1]-F.x3vec[0])</span>
<span class="sd">        </span>
<span class="sd">        &gt;&gt;&gt; W[&#39;wP&#39;]</span>
<span class="sd">        [[ 1.00000000e+00+0.        j],[0.24690276+0.34159244j],...,[1.07001473e-192-1.48037608e-192j]]</span>
<span class="sd">        </span>
<span class="sd">        &gt;&gt;&gt; # The propagator has nf samples because it is computed only for positive frequencies</span>
<span class="sd">        &gt;&gt;&gt; W[&#39;wP&#39;].shape</span>
<span class="sd">        (513, 1)</span>
<span class="sd">        </span>
<span class="sd">        &gt;&gt;&gt; # AdjointMedium=False, hence, we expect output &#39;None&#39;</span>
<span class="sd">        &gt;&gt;&gt; W[&#39;wPa&#39;]</span>
<span class="sd">       </span>
<span class="sd">       </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="c1"># Check if required input variables are given</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">p3</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">g3</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">dx3</span><span class="p">)):</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;W_propagators_p_w: The input variables </span><span class="se">\&#39;</span><span class="s1">p3</span><span class="se">\&#39;</span><span class="s1">, </span><span class="se">\&#39;</span><span class="s1">g3</span><span class="se">\&#39;</span><span class="s1"> and  </span><span class="se">\&#39;</span><span class="s1">dx3</span><span class="se">\&#39;</span><span class="s1"> must be set as scalars.&#39;</span><span class="p">)</span>
            
        <span class="c1"># If AdjointMedium=True it is required to set p3n=p3(-p1)</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">AdjointMedium</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">p3n</span><span class="p">)):</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;W_propagators_p_w: If AdjointMedium=True the input variable </span><span class="se">\&#39;</span><span class="s1">p3n</span><span class="se">\&#39;</span><span class="s1"> must be set as a scalar.&#39;</span><span class="p">)</span>
        
        <span class="c1"># Make frequency vector</span>
        <span class="k">if</span> <span class="n">w</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Wvec</span><span class="p">()</span>
        <span class="c1"># If frequency is given check if it is a scalar</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">w</span><span class="p">):</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;W_propagators_p_w: If </span><span class="se">\&#39;</span><span class="s1">w</span><span class="se">\&#39;</span><span class="s1"> is set it must be a scalar.&#39;</span><span class="p">)</span>   
        <span class="k">elif</span> <span class="n">w</span><span class="o">.</span><span class="n">real</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;W_propagators_p_w: The real-part of </span><span class="se">\&#39;</span><span class="s1">w</span><span class="se">\&#39;</span><span class="s1"> must not be smaller than 0.&#39;</span><span class="p">)</span> 
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># We define w as an array to be able to use .copy()</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">w</span><span class="p">]])</span>
        
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ReciprocalMedium</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            
            <span class="n">wP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">w</span><span class="o">*</span><span class="n">p3</span><span class="o">*</span><span class="n">dx3</span><span class="p">)</span>
            <span class="n">wM</span> <span class="o">=</span> <span class="n">wP</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">AdjointMedium</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">wPa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">w</span><span class="o">*</span><span class="n">p3n</span><span class="o">*</span><span class="n">dx3</span><span class="p">)</span>
                <span class="n">wMa</span> <span class="o">=</span> <span class="n">wPa</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span> 
                <span class="n">wPa</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">wMa</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">ReciprocalMedium</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            
            <span class="n">wP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">w</span><span class="o">*</span><span class="p">(</span><span class="n">p3</span><span class="o">+</span><span class="n">g3</span><span class="p">)</span><span class="o">*</span><span class="n">dx3</span><span class="p">)</span>
            <span class="n">wM</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">w</span><span class="o">*</span><span class="p">(</span><span class="n">p3</span><span class="o">-</span><span class="n">g3</span><span class="p">)</span><span class="o">*</span><span class="n">dx3</span><span class="p">)</span>
        
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">AdjointMedium</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">wPa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">w</span><span class="o">*</span><span class="p">(</span><span class="n">p3n</span><span class="o">-</span><span class="n">g3</span><span class="p">)</span><span class="o">*</span><span class="n">dx3</span><span class="p">)</span>
                <span class="n">wMa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">w</span><span class="o">*</span><span class="p">(</span><span class="n">p3n</span><span class="o">+</span><span class="n">g3</span><span class="p">)</span><span class="o">*</span><span class="n">dx3</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> 
                <span class="n">wPa</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">wMa</span> <span class="o">=</span> <span class="kc">None</span>
                
        <span class="n">out</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;wP&#39;</span><span class="p">:</span><span class="n">wP</span><span class="p">,</span><span class="s1">&#39;wM&#39;</span><span class="p">:</span><span class="n">wM</span><span class="p">,</span><span class="s1">&#39;wPa&#39;</span><span class="p">:</span><span class="n">wPa</span><span class="p">,</span><span class="s1">&#39;wMa&#39;</span><span class="p">:</span><span class="n">wMa</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">out</span></div>
    
<div class="viewcode-block" id="Layered_NRM_p_w.RT_response_p_w"><a class="viewcode-back" href="../Layered_NRM_p_w.html#Layered_NRM_p_w.Layered_NRM_p_w.RT_response_p_w">[docs]</a>    <span class="k">def</span> <span class="nf">RT_response_p_w</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x3vec</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">avec</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">bvec</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">g1vec</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">g3vec</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">normalisation</span><span class="o">=</span><span class="s1">&#39;flux&#39;</span><span class="p">,</span><span class="n">InternalMultiples</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;computes the reflection and transmission responses from above and from below. If medium parameters are given the computed responses are associated with the given parameters medium. Otherwise, the medium parameters defined in **Layered_NRM_p_w** are used.</span>
<span class="sd">        </span>
<span class="sd">        The medium responses are associated to measurements at :math:`x_3=0` and at :math:`x_3=` &#39;x3vec[-2]&#39; :math:`+\epsilon`, where :math:`\epsilon` is an infinitesimally small positive constant. Hence, the propagation from :math:`x_3=0` to the shallowest interface is included. However, the propagation through the deepest layer is excluded.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">    </span>
<span class="sd">        x3vec : numpy.ndarray, optional</span>
<span class="sd">            Vertical spatial vector :math:`x_3`, for n layers &#39;x3vec&#39; must have the shape (n,). We define the :math:`x_3`-axis as downward-pointing. Implicitly, the first value on the :math:`x_3`-axis is zero (not stored in &#39;x3vec&#39;).</span>
<span class="sd">    </span>
<span class="sd">        avec : numpy.ndarray, optional</span>
<span class="sd">            Medium parameter :math:`\\alpha` (real-valued), for n layers &#39;avec&#39; must have the shape (n,).</span>
<span class="sd">            </span>
<span class="sd">        bvec : numpy.ndarray, optional</span>
<span class="sd">            Medium parameter :math:`\\beta` (real-valued), for n layers &#39;bvec&#39; must have the shape (n,).</span>
<span class="sd">        </span>
<span class="sd">        g1vec : numpy.ndarray, optional</span>
<span class="sd">            Medium parameter :math:`\gamma_1` (real-valued for non-reciprocal media or imaginary-valued for reciprocal media), for n layers &#39;g1vec&#39; must have the shape (n,).</span>
<span class="sd">            </span>
<span class="sd">        g3vec : numpy.ndarray, optional</span>
<span class="sd">            Medium parameter :math:`\gamma_3` (real-valued for non-reciprocal media or imaginary-valued for reciprocal media), for n layers &#39;g3vec&#39; must have the shape (n,).</span>
<span class="sd">            </span>
<span class="sd">        normalisation : str, optional</span>
<span class="sd">            For pressure-normalisation set normalisation=&#39;pressure&#39;, for flux-normalisation set normalisation=&#39;flux&#39;.</span>
<span class="sd">            </span>
<span class="sd">        InternalMultiples : bool, optional</span>
<span class="sd">            To model internal multiples set &#39;InternalMultiples=True&#39;. To ignore internal multiples set &#39;InternalMultiples=False&#39;.</span>
<span class="sd">            </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">    </span>
<span class="sd">        dict</span>
<span class="sd">            Dictionary that contains </span>
<span class="sd">                - **RP**: Reflection response from above.</span>
<span class="sd">                - **TP**: Transmission response from above.</span>
<span class="sd">                - **RM**: Reflection response from below.</span>
<span class="sd">                - **TM**: Transmission response from below.</span>
<span class="sd">                - **RPa**: Reflection response from above (adjoint medium).</span>
<span class="sd">                - **TPa**: Transmission response from above (adjoint medium).</span>
<span class="sd">                - **RMa**: Reflection response from below (adjoint medium).</span>
<span class="sd">                - **TMa**: Transmission response from below (adjoint medium).</span>
<span class="sd">            All medium responses are stored in arrays of shape (nf,1). The variables &#39;RPa&#39;, &#39;TPa&#39;, &#39;RMa&#39; and &#39;TMa&#39; are computed only if one sets &#39;AdjointMedium=True&#39;.</span>
<span class="sd">        </span>
<span class="sd">        References</span>
<span class="sd">        ----------</span>
<span class="sd">        Kees document as soon as it is published.</span>
<span class="sd">        </span>
<span class="sd">        Examples</span>
<span class="sd">        --------</span>

<span class="sd">        &gt;&gt;&gt; from Layered_NRM_p_w import Layered_NRM_p_w as LM</span>
<span class="sd">        &gt;&gt;&gt; import numpy as np</span>
<span class="sd">        </span>
<span class="sd">        &gt;&gt;&gt; # Initialise a wavefield in a 1D reciprocal medium</span>
<span class="sd">        &gt;&gt;&gt; # Here, the parameters are chosen such that the wavefield is purely propagating (not evanescent)</span>
<span class="sd">        &gt;&gt;&gt; F=LM(nt=1024,dt=0.005,x3vec=np.array([100,500,1000,1010]),avec=np.array([5,2,3,4]),bvec=np.array([0.4,3.14,2,1.5]),g1vec=np.array([0.9,2.1,0.3,0.25]),g3vec=np.array([0.7,1.14,0.2,0.3]),p1=2e-4,ReciprocalMedium=False)</span>
<span class="sd">        </span>
<span class="sd">        &gt;&gt;&gt; # Model the medium responses</span>
<span class="sd">        &gt;&gt;&gt; Responses=F.RT_response_p_w(normalisation=&#39;flux&#39;,InternalMultiples=True)</span>
<span class="sd">        &gt;&gt;&gt; # Here are your first medium responses:</span>
<span class="sd">        &gt;&gt;&gt; Rplus = Responses[&#39;RP&#39;]</span>
<span class="sd">        &gt;&gt;&gt; Tplus = Responses[&#39;TP&#39;]</span>
<span class="sd">        </span>
<span class="sd">        &gt;&gt;&gt; # Verify if conservation of energy is satisfied</span>
<span class="sd">        &gt;&gt;&gt; Rplus.conj()*Rplus+Tplus.conj()*Tplus</span>
<span class="sd">        ([[1.+0.j], [1.+0.j], ..., [1.+0.j]])</span>
<span class="sd">        </span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="c1"># Check if normalisation is set correctly</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">normalisation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="s1">&#39;flux&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">normalisation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="s1">&#39;pressure&#39;</span><span class="p">):</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;RT_response_p_w: The input variable </span><span class="se">\&#39;</span><span class="s1">normalisation</span><span class="se">\&#39;</span><span class="s1"> must be set, either to </span><span class="se">\&#39;</span><span class="s1">flux</span><span class="se">\&#39;</span><span class="s1">, or to </span><span class="se">\&#39;</span><span class="s1">pressure</span><span class="se">\&#39;</span><span class="s1">.&#39;</span><span class="p">)</span>
        <span class="c1"># Medium responses of the adjoint medium can only be computed in flux-normalisation</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">AdjointMedium</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">normalisation</span> <span class="ow">is</span> <span class="s1">&#39;pressure&#39;</span><span class="p">):</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;RT_response_p_w: We have defined the scattering coefficients of the adjoint medium only for flux-normalisation.&#39;</span><span class="p">)</span>
        
        <span class="c1"># Check if a layer stack is given</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x3vec</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">avec</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> 
        <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bvec</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">g1vec</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> 
        <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">g3vec</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
            
            <span class="c1"># Create a wavefield in a sub-medium</span>
            <span class="c1"># I do this because when the sub-wavefield is initialised all parameters </span>
            <span class="c1"># are automatically tested for correctness</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">SubSelf</span> <span class="o">=</span> <span class="n">Layered_NRM_p_w</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nt</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">nr</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">dx1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">,</span><span class="n">x3vec</span><span class="o">=</span><span class="n">x3vec</span><span class="p">,</span><span class="n">avec</span><span class="o">=</span><span class="n">avec</span><span class="p">,</span><span class="n">bvec</span><span class="o">=</span><span class="n">bvec</span><span class="p">,</span>
                                           <span class="n">g1vec</span><span class="o">=</span><span class="n">g1vec</span><span class="p">,</span><span class="n">g3vec</span><span class="o">=</span><span class="n">g3vec</span><span class="p">,</span><span class="n">p1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">p1</span><span class="p">,</span><span class="n">ReciprocalMedium</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ReciprocalMedium</span><span class="p">,</span>
                                           <span class="n">AdjointMedium</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">AdjointMedium</span><span class="p">)</span>
            
            <span class="n">x3vec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SubSelf</span><span class="o">.</span><span class="n">x3vec</span>
            <span class="n">bvec</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SubSelf</span><span class="o">.</span><span class="n">bvec</span>
            <span class="n">g3vec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SubSelf</span><span class="o">.</span><span class="n">g3vec</span>
            <span class="n">p3</span>    <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SubSelf</span><span class="o">.</span><span class="n">p3</span>
            <span class="n">p3n</span>   <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SubSelf</span><span class="o">.</span><span class="n">p3n</span>
        
<span class="c1">#            del self.Subself</span>
                
        <span class="c1"># Else compute response of entire medium</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x3vec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x3vec</span>
            <span class="n">bvec</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bvec</span>
            <span class="n">g3vec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">g3vec</span>
            <span class="n">p3</span>    <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p3</span>
            <span class="n">p3n</span>   <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p3n</span>
            
        
        <span class="c1"># Number of layers</span>
        <span class="n">N</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">x3vec</span><span class="p">)</span>
        
        <span class="c1"># Vector with layer thicknesses</span>
        <span class="n">dx3vec</span> <span class="o">=</span> <span class="n">x3vec</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">dx3vec</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">x3vec</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">-</span><span class="n">x3vec</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="c1"># Reflection responses: Initial value</span>
        <span class="n">RP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">nf</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
        <span class="n">RM</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">nf</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
        
        <span class="c1"># Here every frequency component has an amplitude equal to one. Hence,</span>
        <span class="c1"># the total wavefield has a strength of sqrt(nt)</span>
        <span class="c1"># When an ifft is applied the wavefield is scaled by 1/sqrt(nt).</span>
        <span class="c1"># Hence in the time domain the wavefield has an amplitude equal to one.</span>
        <span class="n">TP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">nf</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
        <span class="n">TM</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">nf</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
        
        <span class="c1"># Internal multiple operator: Initial value</span>
        <span class="n">M1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">nf</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
        <span class="n">M2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">nf</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">AdjointMedium</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">RPa</span> <span class="o">=</span> <span class="n">RP</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">RMa</span> <span class="o">=</span> <span class="n">RM</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">TPa</span> <span class="o">=</span> <span class="n">TP</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">TMa</span> <span class="o">=</span> <span class="n">TM</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">RPa</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">TPa</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">RMa</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">TMa</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="c1"># Loop over N-1 interfaces</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">N</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            
            <span class="c1"># Scattering coefficients</span>
            <span class="n">ScatCoeffs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">RT_p_w</span><span class="p">(</span><span class="n">beta_u</span><span class="o">=</span><span class="n">bvec</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>  <span class="p">,</span><span class="n">g3_u</span><span class="o">=</span><span class="n">g3vec</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>  <span class="p">,</span><span class="n">p3_u</span><span class="o">=</span><span class="n">p3</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>  <span class="p">,</span><span class="n">p3n_u</span><span class="o">=</span><span class="n">p3n</span><span class="p">[</span><span class="n">n</span><span class="p">],</span>
                                     <span class="n">beta_l</span><span class="o">=</span><span class="n">bvec</span><span class="p">[</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span><span class="n">g3_l</span><span class="o">=</span><span class="n">g3vec</span><span class="p">[</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span><span class="n">p3_l</span><span class="o">=</span><span class="n">p3</span><span class="p">[</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span><span class="n">p3n_l</span><span class="o">=</span><span class="n">p3n</span><span class="p">[</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span>
                                     <span class="n">normalisation</span><span class="o">=</span><span class="n">normalisation</span><span class="p">)</span>
            
            <span class="n">rP</span> <span class="o">=</span> <span class="n">ScatCoeffs</span><span class="p">[</span><span class="s1">&#39;rP&#39;</span><span class="p">]</span>
            <span class="n">tP</span> <span class="o">=</span> <span class="n">ScatCoeffs</span><span class="p">[</span><span class="s1">&#39;tP&#39;</span><span class="p">]</span>
            <span class="n">rM</span> <span class="o">=</span> <span class="n">ScatCoeffs</span><span class="p">[</span><span class="s1">&#39;rM&#39;</span><span class="p">]</span>
            <span class="n">tM</span> <span class="o">=</span> <span class="n">ScatCoeffs</span><span class="p">[</span><span class="s1">&#39;tM&#39;</span><span class="p">]</span>
            
            <span class="c1"># Propagators</span>
            <span class="n">W</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">W_propagators_p_w</span><span class="p">(</span><span class="n">p3</span><span class="o">=</span><span class="n">p3</span><span class="p">[</span><span class="n">n</span><span class="p">],</span><span class="n">p3n</span><span class="o">=</span><span class="n">p3n</span><span class="p">[</span><span class="n">n</span><span class="p">],</span><span class="n">g3</span><span class="o">=</span><span class="n">g3vec</span><span class="p">[</span><span class="n">n</span><span class="p">],</span><span class="n">dx3</span><span class="o">=</span><span class="n">dx3vec</span><span class="p">[</span><span class="n">n</span><span class="p">])</span>
            <span class="n">WP</span> <span class="o">=</span> <span class="n">W</span><span class="p">[</span><span class="s1">&#39;wP&#39;</span><span class="p">]</span>
            <span class="n">WM</span> <span class="o">=</span> <span class="n">W</span><span class="p">[</span><span class="s1">&#39;wM&#39;</span><span class="p">]</span>
            
            <span class="k">if</span> <span class="n">InternalMultiples</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">M1</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">RM</span><span class="o">*</span><span class="n">WM</span><span class="o">*</span><span class="n">rP</span><span class="o">*</span><span class="n">WP</span><span class="p">)</span>
                <span class="n">M2</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">rP</span><span class="o">*</span><span class="n">WP</span><span class="o">*</span><span class="n">RM</span><span class="o">*</span><span class="n">WM</span><span class="p">)</span>
            
            <span class="c1"># Update reflection / transmission responses</span>
            <span class="n">RP</span> <span class="o">=</span> <span class="n">RP</span> <span class="o">+</span> <span class="n">TM</span><span class="o">*</span><span class="n">WM</span><span class="o">*</span><span class="n">rP</span><span class="o">*</span><span class="n">WP</span><span class="o">*</span><span class="n">M1</span><span class="o">*</span><span class="n">TP</span>
            <span class="n">RM</span> <span class="o">=</span> <span class="n">rM</span> <span class="o">+</span> <span class="n">tP</span><span class="o">*</span><span class="n">WP</span><span class="o">*</span><span class="n">RM</span><span class="o">*</span><span class="n">WM</span><span class="o">*</span><span class="n">M2</span><span class="o">*</span><span class="n">tM</span>
            <span class="n">TP</span> <span class="o">=</span> <span class="n">tP</span><span class="o">*</span><span class="n">WP</span><span class="o">*</span><span class="n">M1</span><span class="o">*</span><span class="n">TP</span>
            <span class="n">TM</span> <span class="o">=</span> <span class="n">TM</span><span class="o">*</span><span class="n">WM</span><span class="o">*</span><span class="n">M2</span><span class="o">*</span><span class="n">tM</span>  
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">AdjointMedium</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">rP</span> <span class="o">=</span> <span class="n">ScatCoeffs</span><span class="p">[</span><span class="s1">&#39;rPa&#39;</span><span class="p">]</span>
                <span class="n">tP</span> <span class="o">=</span> <span class="n">ScatCoeffs</span><span class="p">[</span><span class="s1">&#39;tPa&#39;</span><span class="p">]</span>
                <span class="n">rM</span> <span class="o">=</span> <span class="n">ScatCoeffs</span><span class="p">[</span><span class="s1">&#39;rMa&#39;</span><span class="p">]</span>
                <span class="n">tM</span> <span class="o">=</span> <span class="n">ScatCoeffs</span><span class="p">[</span><span class="s1">&#39;tMa&#39;</span><span class="p">]</span>
                <span class="n">WP</span> <span class="o">=</span> <span class="n">W</span><span class="p">[</span><span class="s1">&#39;wPa&#39;</span><span class="p">]</span>
                <span class="n">WM</span> <span class="o">=</span> <span class="n">W</span><span class="p">[</span><span class="s1">&#39;wMa&#39;</span><span class="p">]</span>
            
                <span class="k">if</span> <span class="n">InternalMultiples</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">M1</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">RMa</span><span class="o">*</span><span class="n">WM</span><span class="o">*</span><span class="n">rP</span><span class="o">*</span><span class="n">WP</span><span class="p">)</span>
                    <span class="n">M2</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">rP</span><span class="o">*</span><span class="n">WP</span><span class="o">*</span><span class="n">RMa</span><span class="o">*</span><span class="n">WM</span><span class="p">)</span>
                
                <span class="c1"># Update reflection / transmission responses</span>
                <span class="n">RPa</span> <span class="o">=</span> <span class="n">RPa</span> <span class="o">+</span> <span class="n">TMa</span><span class="o">*</span><span class="n">WM</span><span class="o">*</span><span class="n">rP</span><span class="o">*</span><span class="n">WP</span><span class="o">*</span><span class="n">M1</span><span class="o">*</span><span class="n">TPa</span>
                <span class="n">RMa</span> <span class="o">=</span> <span class="n">rM</span> <span class="o">+</span> <span class="n">tP</span><span class="o">*</span><span class="n">WP</span><span class="o">*</span><span class="n">RMa</span><span class="o">*</span><span class="n">WM</span><span class="o">*</span><span class="n">M2</span><span class="o">*</span><span class="n">tM</span>
                <span class="n">TPa</span> <span class="o">=</span> <span class="n">tP</span><span class="o">*</span><span class="n">WP</span><span class="o">*</span><span class="n">M1</span><span class="o">*</span><span class="n">TPa</span>
                <span class="n">TMa</span> <span class="o">=</span> <span class="n">TMa</span><span class="o">*</span><span class="n">WM</span><span class="o">*</span><span class="n">M2</span><span class="o">*</span><span class="n">tM</span>  
                
        <span class="c1"># Verbose: Inform the user if any wavefield contains NaNs of Infs.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            
            <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">RP</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">TP</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">RM</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">TM</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>\
                <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">RP</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">TP</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">RM</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">TM</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;RT_response_p_w:&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">+</span><span class="mi">100</span><span class="o">*</span><span class="s1">&#39;-&#39;</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;One of the modelled wavefields in the true medium contains a NaN (Not a Number) or an Inf (infinite) element.&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">RP</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> - RP contains &#39;</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">RP</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39; NaN.&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">RP</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> - RP contains &#39;</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">RP</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39; Inf.&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">TP</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> - TP contains &#39;</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">TP</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39; NaN.&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">TP</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> - TP contains &#39;</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">TP</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39; Inf.&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">RM</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> - RM contains &#39;</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">RM</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39; NaN.&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">RM</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> - RM contains &#39;</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">RM</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39; Inf.&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">TM</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> - TM contains &#39;</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">TM</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39; NaN.&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">TM</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> - TM contains &#39;</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">TM</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39; Inf.&#39;</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">AdjointMedium</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                
                <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">RPa</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">TPa</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">RMa</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">TMa</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>\
                <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">RPa</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">TPa</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">RMa</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">TMa</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;RT_response_p_w:&#39;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">+</span><span class="mi">100</span><span class="o">*</span><span class="s1">&#39;-&#39;</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;One of the modelled wavefields in the adoint medium contains a NaN (Not a Number) or an Inf (infinite) element.&#39;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">RPa</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> - RPa contains &#39;</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">RPa</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39; NaN.&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">RPa</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> - RPa contains &#39;</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">RPa</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39; Inf.&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">TPa</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> - TPa contains &#39;</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">TPa</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39; NaN.&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">TPa</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> - TPa contains &#39;</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">TPa</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39; Inf.&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">RMa</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> - RMa contains &#39;</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">RMa</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39; NaN.&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">RMa</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> - RMa contains &#39;</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">RMa</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39; Inf.&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">TMa</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> - TMa contains &#39;</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">TMa</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39; NaN.&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">TMa</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> - TMa contains &#39;</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">TMa</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39; Inf.&#39;</span><span class="p">)</span>
                
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

                
        <span class="n">out</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;RP&#39;</span><span class="p">:</span><span class="n">RP</span><span class="p">,</span><span class="s1">&#39;TP&#39;</span><span class="p">:</span><span class="n">TP</span><span class="p">,</span><span class="s1">&#39;RM&#39;</span><span class="p">:</span><span class="n">RM</span><span class="p">,</span><span class="s1">&#39;TM&#39;</span><span class="p">:</span><span class="n">TM</span><span class="p">,</span><span class="s1">&#39;RPa&#39;</span><span class="p">:</span><span class="n">RPa</span><span class="p">,</span><span class="s1">&#39;TPa&#39;</span><span class="p">:</span><span class="n">TPa</span><span class="p">,</span><span class="s1">&#39;RMa&#39;</span><span class="p">:</span><span class="n">RMa</span><span class="p">,</span><span class="s1">&#39;TMa&#39;</span><span class="p">:</span><span class="n">TMa</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">out</span></div>
            
    <span class="c1"># Insert a layer in the model    </span>
<div class="viewcode-block" id="Layered_NRM_p_w.Insert_layer"><a class="viewcode-back" href="../Layered_NRM_p_w.html#Layered_NRM_p_w.Layered_NRM_p_w.Insert_layer">[docs]</a>    <span class="k">def</span> <span class="nf">Insert_layer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x3</span><span class="p">,</span><span class="n">UpdateSelf</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;inserts a transparent interface at the depth level &#39;x3&#39;. If &#39;x3&#39; coincides with an interface of the model the model&#39;s interface is left unchanged. If &#39;x3&#39; is a vector it is interpreted as multiple depth levels at which transparent interfaces will be inserted.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">    </span>
<span class="sd">        x3 : int, float, numpy.ndarray</span>
<span class="sd">            A depth level, or a vector of depth levels, at which a transparent interface will be inserted. The variable &#39;x3&#39; either must be a scalar, or have the shape (n,). Each element of &#39;x3&#39; must be real-valued and greater than, or equal to zero.</span>
<span class="sd">    </span>
<span class="sd">        UpdateSelf : bool, optional</span>
<span class="sd">            Set &#39;UpdateSelf=True&#39; to not only output an updated model but also update the &#39;self&#39; parameters.</span>
<span class="sd">            </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">    </span>
<span class="sd">        dict</span>
<span class="sd">            Dictionary that contains </span>
<span class="sd">                - **x3vec**: Updated depth vector.</span>
<span class="sd">                - **avec**: Updated :math:`\\alpha` vector.</span>
<span class="sd">                - **bvec**: Updated :math:`\\beta` vector.</span>
<span class="sd">                - **g1vec**: Updated :math:`\gamma_1` vector.</span>
<span class="sd">                - **g3vec**: Updated :math:`\gamma_3` vector.</span>
<span class="sd">                - **p3**: Updated :math:`p_3(p_1)` vector.</span>
<span class="sd">                - **p3n**: Updated :math:`p_3(-p_1)` vector.</span>
<span class="sd">            All medium parameter vectors are stored in arrays of shape (n,).</span>
<span class="sd">        </span>
<span class="sd">        Examples</span>
<span class="sd">        --------</span>

<span class="sd">        &gt;&gt;&gt; from Layered_NRM_p_w import Layered_NRM_p_w as LM</span>
<span class="sd">        &gt;&gt;&gt; import numpy as np</span>
<span class="sd">        </span>
<span class="sd">        &gt;&gt;&gt; # Initialise a wavefield in a 1D reciprocal medium</span>
<span class="sd">        &gt;&gt;&gt; F=LM(nt=1024,dt=0.005,x3vec=np.array([10,150,200]),avec=np.array([1,2,3]),</span>
<span class="sd">        &gt;&gt;&gt;      bvec=np.array([0.4,3.14,2]),g1vec=np.array([0.9,2.1,0.3]),</span>
<span class="sd">        &gt;&gt;&gt;      g3vec=np.array([0.7,1.14,0.2]),p1=2e-4)</span>
<span class="sd">        </span>
<span class="sd">        &gt;&gt;&gt; # Insert a transparent layer at x3=1</span>
<span class="sd">        &gt;&gt;&gt; out=F.Insert_layer(x3=1,UpdateSelf=False)</span>
<span class="sd">        </span>
<span class="sd">        &gt;&gt;&gt; # Updated depth vector</span>
<span class="sd">        &gt;&gt;&gt; out[&#39;x3vec&#39;]</span>
<span class="sd">        array([  1,  10, 150, 200])</span>
<span class="sd">        </span>
<span class="sd">        &gt;&gt;&gt; # Updated alpha vector</span>
<span class="sd">        &gt;&gt;&gt; out[&#39;avec&#39;]</span>
<span class="sd">        array([1, 1, 2, 3])</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="c1"># Check if x3 is a scalar or an array of the shape (n,).</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span>    <span class="nb">isinstance</span><span class="p">(</span><span class="n">x3</span><span class="p">,</span><span class="nb">int</span><span class="p">)</span> 
                <span class="ow">or</span>  <span class="nb">isinstance</span><span class="p">(</span><span class="n">x3</span><span class="p">,</span><span class="nb">float</span><span class="p">)</span> 
                <span class="ow">or</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x3</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="n">x3</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">):</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Insert_layer: The input variable </span><span class="se">\&#39;</span><span class="s1">x3</span><span class="se">\&#39;</span><span class="s1"> must be either a &#39;</span>
                     <span class="o">+</span><span class="s1">&#39;scalar, or an array of shape (n,).&#39;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x3</span><span class="p">,</span><span class="nb">int</span><span class="p">)</span> <span class="ow">or</span>  <span class="nb">isinstance</span><span class="p">(</span><span class="n">x3</span><span class="p">,</span><span class="nb">float</span><span class="p">):</span>
            <span class="n">x3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x3</span><span class="p">])</span>
        
        <span class="c1"># Check if x3 is real-valued.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isreal</span><span class="p">(</span><span class="n">x3</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Insert_layer: The input variable </span><span class="se">\&#39;</span><span class="s1">x3</span><span class="se">\&#39;</span><span class="s1"> must be real-valued.&#39;</span><span class="p">)</span>
        
        <span class="c1"># Check if all elements of x3 are greater than, or equal to zero.</span>
        <span class="k">if</span> <span class="n">x3</span><span class="p">[</span><span class="n">x3</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Insert_layer: Each element of the input variable </span><span class="se">\&#39;</span><span class="s1">x3</span><span class="se">\&#39;</span><span class="s1"> must be  greater than, or equal to zero.&#39;</span><span class="p">)</span>
        
        <span class="n">X3vec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x3vec</span>
        <span class="n">Avec</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">avec</span>
        <span class="n">Bvec</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bvec</span>
        <span class="n">G1vec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">g1vec</span>
        <span class="n">G3vec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">g3vec</span>
        <span class="n">P3</span>    <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p3</span>
        <span class="n">P3n</span>   <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p3n</span>
        
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">x3</span><span class="p">)):</span>
        
            <span class="c1"># Vector of depths smaller than or equal to x3[i]</span>
            <span class="n">L</span> <span class="o">=</span> <span class="n">X3vec</span><span class="p">[</span><span class="n">X3vec</span><span class="o">&lt;=</span><span class="n">x3</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> 
            
            <span class="c1"># Case1: x3[i] smaller than X3vec[0]</span>
            <span class="k">if</span> <span class="n">L</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">X3vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">x3</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>   <span class="p">,</span><span class="n">X3vec</span><span class="p">])</span>
                <span class="n">Avec</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">Avec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">,</span><span class="n">Avec</span><span class="p">])</span>
                <span class="n">Bvec</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">Bvec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">,</span><span class="n">Bvec</span><span class="p">])</span>
                <span class="n">G1vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">G1vec</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">G1vec</span><span class="p">])</span>
                <span class="n">G3vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">G3vec</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">G3vec</span><span class="p">])</span>
                <span class="n">P3</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">P3</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>   <span class="p">,</span><span class="n">P3</span><span class="p">])</span>
                <span class="n">P3n</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">P3n</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="p">,</span><span class="n">P3n</span><span class="p">])</span>
            
            <span class="c1"># Case2: x3[i] coincides with an element of X3vec</span>
            <span class="k">elif</span> <span class="n">L</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">x3</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="n">X3vec</span> <span class="o">=</span> <span class="n">X3vec</span>
                <span class="n">Avec</span>  <span class="o">=</span> <span class="n">Avec</span>
                <span class="n">Bvec</span>  <span class="o">=</span> <span class="n">Bvec</span>
                <span class="n">G1vec</span> <span class="o">=</span> <span class="n">G1vec</span>
                <span class="n">G3vec</span> <span class="o">=</span> <span class="n">G3vec</span>
                <span class="n">P3</span>    <span class="o">=</span> <span class="n">P3</span>
                <span class="n">P3n</span>   <span class="o">=</span> <span class="n">P3n</span>
            
            <span class="c1"># Case 3: x3[i] is larger than X3vec[-1]</span>
            <span class="k">elif</span> <span class="n">L</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="n">X3vec</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
                <span class="n">X3vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">X3vec</span><span class="p">,</span><span class="n">x3</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
                <span class="n">Avec</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">Avec</span> <span class="p">,</span><span class="n">Avec</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
                <span class="n">Bvec</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">Bvec</span> <span class="p">,</span><span class="n">Bvec</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
                <span class="n">G1vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">G1vec</span><span class="p">,</span><span class="n">G1vec</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
                <span class="n">G3vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">G3vec</span><span class="p">,</span><span class="n">G3vec</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
                <span class="n">P3</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">P3</span>   <span class="p">,</span><span class="n">P3</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
                <span class="n">P3n</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">P3n</span>  <span class="p">,</span><span class="n">P3n</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
                
            <span class="c1"># Case 4: x3[i] is between X3vec[0] and X3vec[-1] AND does not coincide with any element of X3vec</span>
            <span class="k">else</span><span class="p">:</span>
                
                <span class="n">b</span> <span class="o">=</span> <span class="n">L</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> 
                <span class="n">ind</span> <span class="o">=</span> <span class="n">X3vec</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
                
                <span class="n">X3vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">X3vec</span><span class="p">[:</span><span class="n">ind</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span><span class="n">x3</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>       <span class="p">,</span><span class="n">X3vec</span><span class="p">[</span><span class="n">ind</span><span class="o">+</span><span class="mi">1</span><span class="p">:]])</span>
                <span class="n">Avec</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">Avec</span><span class="p">[:</span><span class="n">ind</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="p">,</span><span class="n">Avec</span><span class="p">[</span><span class="n">ind</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="p">,</span><span class="n">Avec</span><span class="p">[</span><span class="n">ind</span><span class="o">+</span><span class="mi">1</span><span class="p">:]])</span>
                <span class="n">Bvec</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">Bvec</span><span class="p">[:</span><span class="n">ind</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="p">,</span><span class="n">Bvec</span><span class="p">[</span><span class="n">ind</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="p">,</span><span class="n">Bvec</span><span class="p">[</span><span class="n">ind</span><span class="o">+</span><span class="mi">1</span><span class="p">:]])</span>
                <span class="n">G1vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">G1vec</span><span class="p">[:</span><span class="n">ind</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span><span class="n">G1vec</span><span class="p">[</span><span class="n">ind</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span><span class="n">G1vec</span><span class="p">[</span><span class="n">ind</span><span class="o">+</span><span class="mi">1</span><span class="p">:]])</span>
                <span class="n">G3vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">G3vec</span><span class="p">[:</span><span class="n">ind</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span><span class="n">G3vec</span><span class="p">[</span><span class="n">ind</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span><span class="n">G3vec</span><span class="p">[</span><span class="n">ind</span><span class="o">+</span><span class="mi">1</span><span class="p">:]])</span>
                <span class="n">P3</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">P3</span><span class="p">[:</span><span class="n">ind</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>   <span class="p">,</span><span class="n">P3</span><span class="p">[</span><span class="n">ind</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>   <span class="p">,</span><span class="n">P3</span><span class="p">[</span><span class="n">ind</span><span class="o">+</span><span class="mi">1</span><span class="p">:]])</span>
                <span class="n">P3n</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">P3n</span><span class="p">[:</span><span class="n">ind</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>  <span class="p">,</span><span class="n">P3n</span><span class="p">[</span><span class="n">ind</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>  <span class="p">,</span><span class="n">P3n</span><span class="p">[</span><span class="n">ind</span><span class="o">+</span><span class="mi">1</span><span class="p">:]])</span>
            
        <span class="c1"># Update self: Apply layer insertion to the self-parameters    </span>
        <span class="k">if</span> <span class="n">UpdateSelf</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">x3vec</span> <span class="o">=</span> <span class="n">X3vec</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">avec</span>  <span class="o">=</span> <span class="n">Avec</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bvec</span>  <span class="o">=</span> <span class="n">Bvec</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">g1vec</span> <span class="o">=</span> <span class="n">G1vec</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">g3vec</span> <span class="o">=</span> <span class="n">G3vec</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">p3</span>    <span class="o">=</span> <span class="n">P3</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">p3n</span>   <span class="o">=</span> <span class="n">P3n</span>
            
        <span class="n">out</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;x3vec&#39;</span><span class="p">:</span><span class="n">X3vec</span><span class="p">,</span><span class="s1">&#39;avec&#39;</span><span class="p">:</span><span class="n">Avec</span><span class="p">,</span><span class="s1">&#39;bvec&#39;</span><span class="p">:</span><span class="n">Bvec</span><span class="p">,</span><span class="s1">&#39;g1vec&#39;</span><span class="p">:</span><span class="n">G1vec</span><span class="p">,</span><span class="s1">&#39;g3vec&#39;</span><span class="p">:</span><span class="n">G3vec</span><span class="p">,</span><span class="s1">&#39;p3&#39;</span><span class="p">:</span><span class="n">P3</span><span class="p">,</span><span class="s1">&#39;p3n&#39;</span><span class="p">:</span><span class="n">P3n</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">out</span></div>
    
<div class="viewcode-block" id="Layered_NRM_p_w.GreensFunction_p_w"><a class="viewcode-back" href="../Layered_NRM_p_w.html#Layered_NRM_p_w.Layered_NRM_p_w.GreensFunction_p_w">[docs]</a>    <span class="k">def</span> <span class="nf">GreensFunction_p_w</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x3R</span><span class="p">,</span><span class="n">x3S</span><span class="p">,</span><span class="n">normalisation</span><span class="o">=</span><span class="s1">&#39;flux&#39;</span><span class="p">,</span><span class="n">InternalMultiples</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;computes the one-way Green\&#39;s functions for a receiver and source depth defined by the input variables \&#39;x3R\&#39; and \&#39;x3S\&#39;. The one-way wavefields are decomposed at the receiver- and at the source-side. We define the receiver and source depths just below \&#39;x3R\&#39; and \&#39;x3S\&#39;, respectively (this is important if the receiver or source depth coincides with an interface).</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">    </span>
<span class="sd">        x3R : int,float</span>
<span class="sd">            Receiver depth.</span>
<span class="sd">    </span>
<span class="sd">        x3S : int, float</span>
<span class="sd">            Source depth.</span>
<span class="sd">            </span>
<span class="sd">        normalisation : str, optional</span>
<span class="sd">            For pressure-normalisation set normalisation=&#39;pressure&#39;, for flux-normalisation set normalisation=&#39;flux&#39;.</span>
<span class="sd">            </span>
<span class="sd">        InternalMultiples : bool, optional</span>
<span class="sd">            To model internal multiples set &#39;InternalMultiples=True&#39;. To ignore internal multiples set &#39;InternalMultiples=False&#39;.</span>
<span class="sd">            </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">    </span>
<span class="sd">        dict</span>
<span class="sd">            Dictionary that contains </span>
<span class="sd">                - **GPP**: Green\&#39;s function :math:`G^{+,+}` (true medium).</span>
<span class="sd">                - **GPM**: Green\&#39;s function :math:`G^{+,-}` (true medium).</span>
<span class="sd">                - **GMP**: Green\&#39;s function :math:`G^{-,+}` (true medium).</span>
<span class="sd">                - **GMM**: Green\&#39;s function :math:`G^{-,-}` (true medium).</span>
<span class="sd">                - **GPPa**: Green\&#39;s function :math:`G^{+,+}` (adjoint medium).</span>
<span class="sd">                - **GPMa**: Green\&#39;s function :math:`G^{+,-}` (adjoint medium).</span>
<span class="sd">                - **GMPa**: Green\&#39;s function :math:`G^{-,+}` (adjoint medium).</span>
<span class="sd">                - **GMMa**: Green\&#39;s function :math:`G^{-,-}` (adjoint medium).</span>
<span class="sd">            All medium responses are stored in arrays of shape (nf,1). The variables &#39;GPPa&#39;, &#39;GPMa&#39;, &#39;GMPa&#39; and &#39;GMMa&#39; are computed only if one sets &#39;AdjointMedium=True&#39;.</span>
<span class="sd">        </span>
<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        </span>
<span class="sd">        - The superscript \&#39;+\&#39; and \&#39;-\&#39; refer to downgoing and upgoing waves, respectively.</span>
<span class="sd">        - The first superscript refers to the wavefield at the receiver-side.</span>
<span class="sd">        - The second superscript refers to the wavefield at the source-side.</span>
<span class="sd">        </span>
<span class="sd">        References</span>
<span class="sd">        ----------</span>
<span class="sd">        Kees document as soon as it is published.</span>
<span class="sd">        </span>
<span class="sd">        Examples</span>
<span class="sd">        --------</span>

<span class="sd">        &gt;&gt;&gt; from Layered_NRM_p_w import Layered_NRM_p_w as LM</span>
<span class="sd">        &gt;&gt;&gt; import numpy as np</span>

<span class="sd">        &gt;&gt;&gt; F=LM( nt=1024,dt=0.005,x3vec=np.array([10,150,200]),</span>
<span class="sd">        &gt;&gt;&gt;       avec=np.array([1,2,3]),bvec=np.array([0.4,3.14,2]),</span>
<span class="sd">        &gt;&gt;&gt;       g1vec=np.array([0.9,2.1,0.3]),g3vec=np.array([0.7,1.14,0.2]),</span>
<span class="sd">        &gt;&gt;&gt;       p1=2e-4,ReciprocalMedium=False,AdjointMedium=True )</span>
<span class="sd">        </span>
<span class="sd">        &gt;&gt;&gt; G = F.GreensFunction_p_w(x3R=0,x3S=0,normalisation=normalisation,</span>
<span class="sd">        &gt;&gt;&gt;                          InternalMultiples=InternalMultiples)</span>
<span class="sd">        &gt;&gt;&gt; RT=F.RT_response_p_w(normalisation=normalisation,</span>
<span class="sd">        &gt;&gt;&gt;                      InternalMultiples=InternalMultiples)</span>
<span class="sd">        &gt;&gt;&gt; np.linalg.norm(RT[&#39;RP&#39;]-G[&#39;GMP&#39;]</span>
<span class="sd">        0.0</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="c1"># Insert transparent interfaces at source and receiver depth levels</span>
        <span class="c1"># The insertion implicitly checks that x3R and x3S are non-negative </span>
        <span class="c1"># real-valued scalars</span>
        <span class="c1"># If the receiver or source depth is greater than, or equal to the </span>
        <span class="c1"># deepest interface, we insert another transparent layer below the  </span>
        <span class="c1"># &#39;new&#39; deepest interface. This is necessary because the function </span>
        <span class="c1"># RT_response_p_w does not compute the propagation through the deepest</span>
        <span class="c1"># layer. By adding a transparent interface below the source/receiver we</span>
        <span class="c1"># ensure that the propagation is computed correctly.</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">x3R</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x3vec</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="ow">or</span> <span class="p">(</span><span class="n">x3S</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x3vec</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">xb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">x3R</span><span class="p">,</span><span class="n">x3S</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span>
            <span class="n">Tmp_medium</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Insert_layer</span><span class="p">(</span><span class="n">x3</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x3R</span><span class="p">,</span><span class="n">x3S</span><span class="p">,</span><span class="n">xb</span><span class="p">]),</span>
                                           <span class="n">UpdateSelf</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Tmp_medium</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Insert_layer</span><span class="p">(</span><span class="n">x3</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x3R</span><span class="p">,</span><span class="n">x3S</span><span class="p">]),</span><span class="n">UpdateSelf</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">X3vec</span> <span class="o">=</span> <span class="n">Tmp_medium</span><span class="p">[</span><span class="s1">&#39;x3vec&#39;</span><span class="p">]</span>
        <span class="n">Avec</span>  <span class="o">=</span> <span class="n">Tmp_medium</span><span class="p">[</span><span class="s1">&#39;avec&#39;</span><span class="p">]</span>
        <span class="n">Bvec</span>  <span class="o">=</span> <span class="n">Tmp_medium</span><span class="p">[</span><span class="s1">&#39;bvec&#39;</span><span class="p">]</span>
        <span class="n">G1vec</span> <span class="o">=</span> <span class="n">Tmp_medium</span><span class="p">[</span><span class="s1">&#39;g1vec&#39;</span><span class="p">]</span>
        <span class="n">G3vec</span> <span class="o">=</span> <span class="n">Tmp_medium</span><span class="p">[</span><span class="s1">&#39;g3vec&#39;</span><span class="p">]</span>
        
        <span class="c1"># Get indices of the receiver and source interfaces</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">X3vec</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">x3R</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">X3vec</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">x3S</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">x3R</span> <span class="o">&gt;</span> <span class="n">x3S</span><span class="p">:</span>
            
            <span class="c1"># Overburden</span>
            <span class="n">x3vec</span> <span class="o">=</span> <span class="n">X3vec</span><span class="p">[:</span><span class="n">s</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">avec</span>  <span class="o">=</span> <span class="n">Avec</span><span class="p">[:</span><span class="n">s</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">bvec</span>  <span class="o">=</span> <span class="n">Bvec</span><span class="p">[:</span><span class="n">s</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">g1vec</span> <span class="o">=</span> <span class="n">G1vec</span><span class="p">[:</span><span class="n">s</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">g3vec</span> <span class="o">=</span> <span class="n">G3vec</span><span class="p">[:</span><span class="n">s</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>
            
            <span class="n">L1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">RT_response_p_w</span><span class="p">(</span><span class="n">x3vec</span><span class="o">=</span><span class="n">x3vec</span><span class="p">,</span><span class="n">avec</span><span class="o">=</span><span class="n">avec</span><span class="p">,</span><span class="n">bvec</span><span class="o">=</span><span class="n">bvec</span><span class="p">,</span>
                                      <span class="n">g1vec</span><span class="o">=</span><span class="n">g1vec</span><span class="p">,</span><span class="n">g3vec</span><span class="o">=</span><span class="n">g3vec</span><span class="p">,</span>
                                      <span class="n">normalisation</span><span class="o">=</span><span class="n">normalisation</span><span class="p">,</span>
                                      <span class="n">InternalMultiples</span><span class="o">=</span><span class="n">InternalMultiples</span><span class="p">)</span>

            <span class="c1"># Sandwiched layer stack</span>
            <span class="n">x3vec</span> <span class="o">=</span> <span class="n">X3vec</span><span class="p">[</span><span class="n">s</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">r</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">X3vec</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
            <span class="n">avec</span>  <span class="o">=</span> <span class="n">Avec</span><span class="p">[</span><span class="n">s</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">r</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">bvec</span>  <span class="o">=</span> <span class="n">Bvec</span><span class="p">[</span><span class="n">s</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">r</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">g1vec</span> <span class="o">=</span> <span class="n">G1vec</span><span class="p">[</span><span class="n">s</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">r</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">g3vec</span> <span class="o">=</span> <span class="n">G3vec</span><span class="p">[</span><span class="n">s</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">r</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>
            
            <span class="n">L2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">RT_response_p_w</span><span class="p">(</span><span class="n">x3vec</span><span class="o">=</span><span class="n">x3vec</span><span class="p">,</span><span class="n">avec</span><span class="o">=</span><span class="n">avec</span><span class="p">,</span><span class="n">bvec</span><span class="o">=</span><span class="n">bvec</span><span class="p">,</span>
                                      <span class="n">g1vec</span><span class="o">=</span><span class="n">g1vec</span><span class="p">,</span><span class="n">g3vec</span><span class="o">=</span><span class="n">g3vec</span><span class="p">,</span>
                                      <span class="n">normalisation</span><span class="o">=</span><span class="n">normalisation</span><span class="p">,</span>
                                      <span class="n">InternalMultiples</span><span class="o">=</span><span class="n">InternalMultiples</span><span class="p">)</span>
            
            <span class="c1"># Underburden</span>
            <span class="n">x3vec</span> <span class="o">=</span> <span class="n">X3vec</span><span class="p">[</span><span class="n">r</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">X3vec</span><span class="p">[</span><span class="n">r</span><span class="p">]</span>
            <span class="n">avec</span>  <span class="o">=</span> <span class="n">Avec</span><span class="p">[</span><span class="n">r</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">bvec</span>  <span class="o">=</span> <span class="n">Bvec</span><span class="p">[</span><span class="n">r</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">g1vec</span> <span class="o">=</span> <span class="n">G1vec</span><span class="p">[</span><span class="n">r</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">g3vec</span> <span class="o">=</span> <span class="n">G3vec</span><span class="p">[</span><span class="n">r</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
            
            <span class="c1"># Exception if underburden is homogeneous</span>
            <span class="k">if</span> <span class="n">x3vec</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">x3vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">avec</span>  <span class="o">=</span> <span class="n">Avec</span><span class="p">[</span><span class="n">r</span><span class="p">:]</span>
                <span class="n">bvec</span>  <span class="o">=</span> <span class="n">Bvec</span><span class="p">[</span><span class="n">r</span><span class="p">:]</span>
                <span class="n">g1vec</span> <span class="o">=</span> <span class="n">G1vec</span><span class="p">[</span><span class="n">r</span><span class="p">:]</span>
                <span class="n">g3vec</span> <span class="o">=</span> <span class="n">G3vec</span><span class="p">[</span><span class="n">r</span><span class="p">:]</span>
            
            <span class="n">L3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">RT_response_p_w</span><span class="p">(</span><span class="n">x3vec</span><span class="o">=</span><span class="n">x3vec</span><span class="p">,</span><span class="n">avec</span><span class="o">=</span><span class="n">avec</span><span class="p">,</span><span class="n">bvec</span><span class="o">=</span><span class="n">bvec</span><span class="p">,</span>
                                      <span class="n">g1vec</span><span class="o">=</span><span class="n">g1vec</span><span class="p">,</span><span class="n">g3vec</span><span class="o">=</span><span class="n">g3vec</span><span class="p">,</span>
                                      <span class="n">normalisation</span><span class="o">=</span><span class="n">normalisation</span><span class="p">,</span>
                                      <span class="n">InternalMultiples</span><span class="o">=</span><span class="n">InternalMultiples</span><span class="p">)</span>

            <span class="c1"># Get variables that are used multiple times to avoid multiple </span>
            <span class="c1"># reading from dictionary</span>
            <span class="n">RM1</span> <span class="o">=</span> <span class="n">L1</span><span class="p">[</span><span class="s1">&#39;RM&#39;</span><span class="p">]</span>
            <span class="n">TP2</span> <span class="o">=</span> <span class="n">L2</span><span class="p">[</span><span class="s1">&#39;TP&#39;</span><span class="p">]</span>
            
            <span class="k">if</span> <span class="n">InternalMultiples</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">M1</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">RM1</span><span class="o">*</span><span class="n">L2</span><span class="p">[</span><span class="s1">&#39;RP&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">M1</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">GPP12</span> <span class="o">=</span>  <span class="n">TP2</span><span class="o">*</span><span class="n">M1</span>
            <span class="n">GPM12</span> <span class="o">=</span> <span class="o">-</span><span class="n">TP2</span><span class="o">*</span><span class="n">M1</span><span class="o">*</span><span class="n">RM1</span> <span class="c1"># Multiply by -1 because upgoing</span>
                                <span class="c1"># sources are defined with </span>
                                <span class="c1"># negative amplitude</span>
                                            
            <span class="c1"># Compute reflection from below of parts 1+2 </span>
            <span class="n">RM12</span> <span class="o">=</span> <span class="n">L2</span><span class="p">[</span><span class="s1">&#39;RM&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">TP2</span><span class="o">*</span><span class="n">M1</span><span class="o">*</span><span class="n">RM1</span><span class="o">*</span><span class="n">L2</span><span class="p">[</span><span class="s1">&#39;TM&#39;</span><span class="p">]</span>
            
            <span class="c1"># Compute the Green&#39;s functions G13 for the complete medium</span>
            <span class="k">if</span> <span class="n">InternalMultiples</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">M2</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">RM12</span><span class="o">*</span><span class="n">L3</span><span class="p">[</span><span class="s1">&#39;RP&#39;</span><span class="p">]</span> <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">M2</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">GPP13</span> <span class="o">=</span> <span class="n">M2</span><span class="o">*</span><span class="n">GPP12</span>
            <span class="n">GPM13</span> <span class="o">=</span> <span class="n">M2</span><span class="o">*</span><span class="n">GPM12</span>
            <span class="n">GMP13</span> <span class="o">=</span> <span class="n">L3</span><span class="p">[</span><span class="s1">&#39;RP&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">M2</span><span class="o">*</span><span class="n">GPP12</span>
            <span class="n">GMM13</span> <span class="o">=</span> <span class="n">L3</span><span class="p">[</span><span class="s1">&#39;RP&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">M2</span><span class="o">*</span><span class="n">GPM12</span>
            
            <span class="c1"># Green;s functions in adjoint medium</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">AdjointMedium</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="c1"># Get variables that are used multiple times to avoid multiple </span>
                <span class="c1"># reading from dictionary</span>
                <span class="n">RM1</span> <span class="o">=</span> <span class="n">L1</span><span class="p">[</span><span class="s1">&#39;RMa&#39;</span><span class="p">]</span>
                <span class="n">TP2</span> <span class="o">=</span> <span class="n">L2</span><span class="p">[</span><span class="s1">&#39;TPa&#39;</span><span class="p">]</span>
                
                <span class="k">if</span> <span class="n">InternalMultiples</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">M1</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">RM1</span><span class="o">*</span><span class="n">L2</span><span class="p">[</span><span class="s1">&#39;RPa&#39;</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">M1</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">GPP12</span> <span class="o">=</span>  <span class="n">TP2</span><span class="o">*</span><span class="n">M1</span>
                <span class="n">GPM12</span> <span class="o">=</span> <span class="o">-</span><span class="n">TP2</span><span class="o">*</span><span class="n">M1</span><span class="o">*</span><span class="n">RM1</span> <span class="c1"># Multiply by -1 because upgoing</span>
                                    <span class="c1"># sources are defined with </span>
                                    <span class="c1"># negative amplitude</span>
                                                
                <span class="c1"># Compute reflection from below of parts 1+2 </span>
                <span class="n">RM12</span> <span class="o">=</span> <span class="n">L2</span><span class="p">[</span><span class="s1">&#39;RMa&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">TP2</span><span class="o">*</span><span class="n">M1</span><span class="o">*</span><span class="n">RM1</span><span class="o">*</span><span class="n">L2</span><span class="p">[</span><span class="s1">&#39;TMa&#39;</span><span class="p">]</span>
                
                <span class="c1"># Compute the Green&#39;s functions G13 for the complete medium</span>
                <span class="k">if</span> <span class="n">InternalMultiples</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">M2</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">RM12</span><span class="o">*</span><span class="n">L3</span><span class="p">[</span><span class="s1">&#39;RPa&#39;</span><span class="p">]</span> <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">M2</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">GPP13a</span> <span class="o">=</span> <span class="n">M2</span><span class="o">*</span><span class="n">GPP12</span>
                <span class="n">GPM13a</span> <span class="o">=</span> <span class="n">M2</span><span class="o">*</span><span class="n">GPM12</span>
                <span class="n">GMP13a</span> <span class="o">=</span> <span class="n">L3</span><span class="p">[</span><span class="s1">&#39;RPa&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">M2</span><span class="o">*</span><span class="n">GPP12</span>
                <span class="n">GMM13a</span> <span class="o">=</span> <span class="n">L3</span><span class="p">[</span><span class="s1">&#39;RPa&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">M2</span><span class="o">*</span><span class="n">GPM12</span>
                
            
            
        <span class="k">elif</span> <span class="n">x3R</span> <span class="o">==</span> <span class="n">x3S</span><span class="p">:</span>
            
            <span class="c1"># Overburden</span>
            <span class="n">x3vec</span> <span class="o">=</span> <span class="n">X3vec</span><span class="p">[:</span><span class="n">s</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">avec</span>  <span class="o">=</span> <span class="n">Avec</span><span class="p">[:</span><span class="n">s</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">bvec</span>  <span class="o">=</span> <span class="n">Bvec</span><span class="p">[:</span><span class="n">s</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">g1vec</span> <span class="o">=</span> <span class="n">G1vec</span><span class="p">[:</span><span class="n">s</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">g3vec</span> <span class="o">=</span> <span class="n">G3vec</span><span class="p">[:</span><span class="n">s</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>
            
            <span class="n">L1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">RT_response_p_w</span><span class="p">(</span><span class="n">x3vec</span><span class="o">=</span><span class="n">x3vec</span><span class="p">,</span><span class="n">avec</span><span class="o">=</span><span class="n">avec</span><span class="p">,</span><span class="n">bvec</span><span class="o">=</span><span class="n">bvec</span><span class="p">,</span>
                                      <span class="n">g1vec</span><span class="o">=</span><span class="n">g1vec</span><span class="p">,</span><span class="n">g3vec</span><span class="o">=</span><span class="n">g3vec</span><span class="p">,</span>
                                      <span class="n">normalisation</span><span class="o">=</span><span class="n">normalisation</span><span class="p">,</span>
                                      <span class="n">InternalMultiples</span><span class="o">=</span><span class="n">InternalMultiples</span><span class="p">)</span>
            
            <span class="c1"># Underburden</span>
            <span class="n">x3vec</span> <span class="o">=</span> <span class="n">X3vec</span><span class="p">[</span><span class="n">r</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">X3vec</span><span class="p">[</span><span class="n">r</span><span class="p">]</span>
            <span class="n">avec</span>  <span class="o">=</span> <span class="n">Avec</span><span class="p">[</span><span class="n">r</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">bvec</span>  <span class="o">=</span> <span class="n">Bvec</span><span class="p">[</span><span class="n">r</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">g1vec</span> <span class="o">=</span> <span class="n">G1vec</span><span class="p">[</span><span class="n">r</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">g3vec</span> <span class="o">=</span> <span class="n">G3vec</span><span class="p">[</span><span class="n">r</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
            
            <span class="c1"># Exception if underburden is homogeneous</span>
            <span class="k">if</span> <span class="n">x3vec</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">x3vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">avec</span>  <span class="o">=</span> <span class="n">Avec</span><span class="p">[</span><span class="n">r</span><span class="p">:]</span>
                <span class="n">bvec</span>  <span class="o">=</span> <span class="n">Bvec</span><span class="p">[</span><span class="n">r</span><span class="p">:]</span>
                <span class="n">g1vec</span> <span class="o">=</span> <span class="n">G1vec</span><span class="p">[</span><span class="n">r</span><span class="p">:]</span>
                <span class="n">g3vec</span> <span class="o">=</span> <span class="n">G3vec</span><span class="p">[</span><span class="n">r</span><span class="p">:]</span>
            
            <span class="n">L3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">RT_response_p_w</span><span class="p">(</span><span class="n">x3vec</span><span class="o">=</span><span class="n">x3vec</span><span class="p">,</span><span class="n">avec</span><span class="o">=</span><span class="n">avec</span><span class="p">,</span><span class="n">bvec</span><span class="o">=</span><span class="n">bvec</span><span class="p">,</span>
                                      <span class="n">g1vec</span><span class="o">=</span><span class="n">g1vec</span><span class="p">,</span><span class="n">g3vec</span><span class="o">=</span><span class="n">g3vec</span><span class="p">,</span>
                                      <span class="n">normalisation</span><span class="o">=</span><span class="n">normalisation</span><span class="p">,</span>
                                      <span class="n">InternalMultiples</span><span class="o">=</span><span class="n">InternalMultiples</span><span class="p">)</span>
          
            <span class="c1"># Get variables that are used multiple times to avoid multiple </span>
            <span class="c1"># reading from dictionary</span>
            <span class="n">RM1</span> <span class="o">=</span> <span class="n">L1</span><span class="p">[</span><span class="s1">&#39;RM&#39;</span><span class="p">]</span>
            <span class="n">RP3</span> <span class="o">=</span> <span class="n">L3</span><span class="p">[</span><span class="s1">&#39;RP&#39;</span><span class="p">]</span>
            
            <span class="k">if</span> <span class="n">InternalMultiples</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">M1</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">RM1</span><span class="o">*</span><span class="n">RP3</span> <span class="p">)</span>
                <span class="n">M2</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">RP3</span><span class="o">*</span><span class="n">RM1</span> <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">M1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">nf</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">nr</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
                <span class="n">M2</span> <span class="o">=</span> <span class="n">M1</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                
            <span class="n">GPP13</span> <span class="o">=</span>  <span class="n">M1</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> 
            <span class="n">GPM13</span> <span class="o">=</span> <span class="o">-</span><span class="n">M1</span><span class="o">*</span><span class="n">RM1</span>     <span class="c1"># Multiply by -1 because upgoing</span>
                                <span class="c1"># sources are defined with </span>
                                <span class="c1"># negative amplitude</span>
            <span class="n">GMP13</span> <span class="o">=</span>  <span class="n">RP3</span><span class="o">*</span><span class="n">M1</span>
            <span class="n">GMM13</span> <span class="o">=</span> <span class="o">-</span><span class="n">M2</span>     <span class="c1"># Multiply by -1 because upgoing</span>
                            <span class="c1"># sources are defined with </span>
                            <span class="c1"># negative amplitude</span>
                            
            <span class="c1"># Green;s functions in adjoint medium</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">AdjointMedium</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="c1"># Get variables that are used multiple times to avoid multiple </span>
                <span class="c1"># reading from dictionary</span>
                <span class="n">RM1</span> <span class="o">=</span> <span class="n">L1</span><span class="p">[</span><span class="s1">&#39;RMa&#39;</span><span class="p">]</span>
                <span class="n">RP3</span> <span class="o">=</span> <span class="n">L3</span><span class="p">[</span><span class="s1">&#39;RPa&#39;</span><span class="p">]</span>
                
                <span class="k">if</span> <span class="n">InternalMultiples</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">M1</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">RM1</span><span class="o">*</span><span class="n">RP3</span> <span class="p">)</span>
                    <span class="n">M2</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">RP3</span><span class="o">*</span><span class="n">RM1</span> <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">M1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">nf</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">nr</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
                    <span class="n">M2</span> <span class="o">=</span> <span class="n">M1</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    
                <span class="n">GPP13a</span> <span class="o">=</span>  <span class="n">M1</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> 
                <span class="n">GPM13a</span> <span class="o">=</span> <span class="o">-</span><span class="n">M1</span><span class="o">*</span><span class="n">RM1</span>     <span class="c1"># Multiply by -1 because upgoing</span>
                                     <span class="c1"># sources are defined with </span>
                                     <span class="c1"># negative amplitude</span>
                <span class="n">GMP13a</span> <span class="o">=</span>  <span class="n">RP3</span><span class="o">*</span><span class="n">M1</span>
                <span class="n">GMM13a</span> <span class="o">=</span> <span class="o">-</span><span class="n">M2</span>     <span class="c1"># Multiply by -1 because upgoing</span>
                                 <span class="c1"># sources are defined with </span>
                                 <span class="c1"># negative amplitude</span>
            
        <span class="k">elif</span> <span class="n">x3R</span> <span class="o">&lt;</span> <span class="n">x3S</span><span class="p">:</span>
            
            <span class="c1"># Overburden</span>
            <span class="n">x3vec</span> <span class="o">=</span> <span class="n">X3vec</span><span class="p">[:</span><span class="n">r</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">avec</span>  <span class="o">=</span> <span class="n">Avec</span><span class="p">[:</span><span class="n">r</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">bvec</span>  <span class="o">=</span> <span class="n">Bvec</span><span class="p">[:</span><span class="n">r</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">g1vec</span> <span class="o">=</span> <span class="n">G1vec</span><span class="p">[:</span><span class="n">r</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">g3vec</span> <span class="o">=</span> <span class="n">G3vec</span><span class="p">[:</span><span class="n">r</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>
            
            <span class="n">L1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">RT_response_p_w</span><span class="p">(</span><span class="n">x3vec</span><span class="o">=</span><span class="n">x3vec</span><span class="p">,</span><span class="n">avec</span><span class="o">=</span><span class="n">avec</span><span class="p">,</span><span class="n">bvec</span><span class="o">=</span><span class="n">bvec</span><span class="p">,</span>
                                      <span class="n">g1vec</span><span class="o">=</span><span class="n">g1vec</span><span class="p">,</span><span class="n">g3vec</span><span class="o">=</span><span class="n">g3vec</span><span class="p">,</span>
                                      <span class="n">normalisation</span><span class="o">=</span><span class="n">normalisation</span><span class="p">,</span>
                                      <span class="n">InternalMultiples</span><span class="o">=</span><span class="n">InternalMultiples</span><span class="p">)</span>
            
            <span class="c1"># Sandwiched layer stack</span>
            <span class="n">x3vec</span> <span class="o">=</span> <span class="n">X3vec</span><span class="p">[</span><span class="n">r</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">s</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">X3vec</span><span class="p">[</span><span class="n">r</span><span class="p">]</span>
            <span class="n">avec</span>  <span class="o">=</span> <span class="n">Avec</span><span class="p">[</span><span class="n">r</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">s</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">bvec</span>  <span class="o">=</span> <span class="n">Bvec</span><span class="p">[</span><span class="n">r</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">s</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">g1vec</span> <span class="o">=</span> <span class="n">G1vec</span><span class="p">[</span><span class="n">r</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">s</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">g3vec</span> <span class="o">=</span> <span class="n">G3vec</span><span class="p">[</span><span class="n">r</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">s</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>
            
            <span class="n">L2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">RT_response_p_w</span><span class="p">(</span><span class="n">x3vec</span><span class="o">=</span><span class="n">x3vec</span><span class="p">,</span><span class="n">avec</span><span class="o">=</span><span class="n">avec</span><span class="p">,</span><span class="n">bvec</span><span class="o">=</span><span class="n">bvec</span><span class="p">,</span>
                                      <span class="n">g1vec</span><span class="o">=</span><span class="n">g1vec</span><span class="p">,</span><span class="n">g3vec</span><span class="o">=</span><span class="n">g3vec</span><span class="p">,</span>
                                      <span class="n">normalisation</span><span class="o">=</span><span class="n">normalisation</span><span class="p">,</span>
                                      <span class="n">InternalMultiples</span><span class="o">=</span><span class="n">InternalMultiples</span><span class="p">)</span>
            
            <span class="c1"># Underburden</span>
            <span class="n">x3vec</span> <span class="o">=</span> <span class="n">X3vec</span><span class="p">[</span><span class="n">s</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">X3vec</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
            <span class="n">avec</span>  <span class="o">=</span> <span class="n">Avec</span><span class="p">[</span><span class="n">s</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">bvec</span>  <span class="o">=</span> <span class="n">Bvec</span><span class="p">[</span><span class="n">s</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">g1vec</span> <span class="o">=</span> <span class="n">G1vec</span><span class="p">[</span><span class="n">s</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">g3vec</span> <span class="o">=</span> <span class="n">G3vec</span><span class="p">[</span><span class="n">s</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
            
            <span class="c1"># Exception if underburden is homogeneous</span>
            <span class="k">if</span> <span class="n">x3vec</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">x3vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">avec</span>  <span class="o">=</span> <span class="n">Avec</span><span class="p">[</span><span class="n">s</span><span class="p">:]</span>
                <span class="n">bvec</span>  <span class="o">=</span> <span class="n">Bvec</span><span class="p">[</span><span class="n">s</span><span class="p">:]</span>
                <span class="n">g1vec</span> <span class="o">=</span> <span class="n">G1vec</span><span class="p">[</span><span class="n">s</span><span class="p">:]</span>
                <span class="n">g3vec</span> <span class="o">=</span> <span class="n">G3vec</span><span class="p">[</span><span class="n">s</span><span class="p">:]</span>
            
            <span class="n">L3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">RT_response_p_w</span><span class="p">(</span><span class="n">x3vec</span><span class="o">=</span><span class="n">x3vec</span><span class="p">,</span><span class="n">avec</span><span class="o">=</span><span class="n">avec</span><span class="p">,</span><span class="n">bvec</span><span class="o">=</span><span class="n">bvec</span><span class="p">,</span>
                                      <span class="n">g1vec</span><span class="o">=</span><span class="n">g1vec</span><span class="p">,</span><span class="n">g3vec</span><span class="o">=</span><span class="n">g3vec</span><span class="p">,</span>
                                      <span class="n">normalisation</span><span class="o">=</span><span class="n">normalisation</span><span class="p">,</span>
                                      <span class="n">InternalMultiples</span><span class="o">=</span><span class="n">InternalMultiples</span><span class="p">)</span>
            
            <span class="c1"># Get variables that are used multiple times to avoid multiple </span>
            <span class="c1"># reading from dictionary</span>
            <span class="n">RM1</span> <span class="o">=</span> <span class="n">L1</span><span class="p">[</span><span class="s1">&#39;RM&#39;</span><span class="p">]</span>
            <span class="n">TM2</span> <span class="o">=</span> <span class="n">L2</span><span class="p">[</span><span class="s1">&#39;TM&#39;</span><span class="p">]</span>
            <span class="n">RP3</span> <span class="o">=</span> <span class="n">L3</span><span class="p">[</span><span class="s1">&#39;RP&#39;</span><span class="p">]</span>
            
            <span class="c1"># Compute reflection from above of part 2+3 </span>
            <span class="k">if</span> <span class="n">InternalMultiples</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">M1</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">RP3</span><span class="o">*</span><span class="n">L2</span><span class="p">[</span><span class="s1">&#39;RM&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">M1</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">RP23</span> <span class="o">=</span> <span class="n">L2</span><span class="p">[</span><span class="s1">&#39;RP&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">TM2</span><span class="o">*</span><span class="n">M1</span><span class="o">*</span><span class="n">RP3</span><span class="o">*</span><span class="n">L2</span><span class="p">[</span><span class="s1">&#39;TP&#39;</span><span class="p">]</span>
            
            <span class="c1"># Compute the Green&#39;s functions G23 that exclude the medium above </span>
            <span class="c1"># the receiver: GMP23,GMM23</span>
            <span class="n">GMP23</span> <span class="o">=</span>  <span class="n">TM2</span><span class="o">*</span><span class="n">M1</span><span class="o">*</span><span class="n">RP3</span>                   
            <span class="n">GMM23</span> <span class="o">=</span> <span class="o">-</span><span class="n">TM2</span><span class="o">*</span><span class="n">M1</span>         <span class="c1"># Multiply by -1 because upgoing</span>
                                    <span class="c1"># sources are defined with </span>
                                    <span class="c1"># negative amplitude</span>
                
            
            
            <span class="c1"># Compute the Green&#39;s functions G13 for the complete medium</span>
            <span class="k">if</span> <span class="n">InternalMultiples</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">M2</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">RP23</span><span class="o">*</span><span class="n">RM1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">M2</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">GPP13</span> <span class="o">=</span> <span class="n">RM1</span><span class="o">*</span><span class="n">M2</span><span class="o">*</span><span class="n">GMP23</span>
            <span class="n">GPM13</span> <span class="o">=</span> <span class="n">RM1</span><span class="o">*</span><span class="n">M2</span><span class="o">*</span><span class="n">GMM23</span>
            <span class="n">GMP13</span> <span class="o">=</span> <span class="n">M2</span><span class="o">*</span><span class="n">GMP23</span>
            <span class="n">GMM13</span> <span class="o">=</span> <span class="n">M2</span><span class="o">*</span><span class="n">GMM23</span>
            
            <span class="c1"># Green;s functions in adjoint medium</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">AdjointMedium</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="c1"># Get variables that are used multiple times to avoid multiple </span>
                <span class="c1"># reading from dictionary</span>
                <span class="n">RM1</span> <span class="o">=</span> <span class="n">L1</span><span class="p">[</span><span class="s1">&#39;RMa&#39;</span><span class="p">]</span>
                <span class="n">TM2</span> <span class="o">=</span> <span class="n">L2</span><span class="p">[</span><span class="s1">&#39;TMa&#39;</span><span class="p">]</span>
                <span class="n">RP3</span> <span class="o">=</span> <span class="n">L3</span><span class="p">[</span><span class="s1">&#39;RPa&#39;</span><span class="p">]</span>
                
                <span class="c1"># Compute reflection from above of part 2+3 </span>
                <span class="k">if</span> <span class="n">InternalMultiples</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">M1</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">RP3</span><span class="o">*</span><span class="n">L2</span><span class="p">[</span><span class="s1">&#39;RMa&#39;</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">M1</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">RP23</span> <span class="o">=</span> <span class="n">L2</span><span class="p">[</span><span class="s1">&#39;RPa&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">TM2</span><span class="o">*</span><span class="n">M1</span><span class="o">*</span><span class="n">RP3</span><span class="o">*</span><span class="n">L2</span><span class="p">[</span><span class="s1">&#39;TPa&#39;</span><span class="p">]</span>
                
                <span class="c1"># Compute the Green&#39;s functions G23 that exclude the medium above </span>
                <span class="c1"># the receiver: GMP23,GMM23</span>
                <span class="n">GMP23</span> <span class="o">=</span>  <span class="n">TM2</span><span class="o">*</span><span class="n">M1</span><span class="o">*</span><span class="n">RP3</span>                   
                <span class="n">GMM23</span> <span class="o">=</span> <span class="o">-</span><span class="n">TM2</span><span class="o">*</span><span class="n">M1</span>         <span class="c1"># Multiply by -1 because upgoing</span>
                                        <span class="c1"># sources are defined with </span>
                                        <span class="c1"># negative amplitude</span>
                    
                
                
                <span class="c1"># Compute the Green&#39;s functions G13 for the complete medium</span>
                <span class="k">if</span> <span class="n">InternalMultiples</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">M2</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">RP23</span><span class="o">*</span><span class="n">RM1</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">M2</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">GPP13a</span> <span class="o">=</span> <span class="n">RM1</span><span class="o">*</span><span class="n">M2</span><span class="o">*</span><span class="n">GMP23</span>
                <span class="n">GPM13a</span> <span class="o">=</span> <span class="n">RM1</span><span class="o">*</span><span class="n">M2</span><span class="o">*</span><span class="n">GMM23</span>
                <span class="n">GMP13a</span> <span class="o">=</span> <span class="n">M2</span><span class="o">*</span><span class="n">GMP23</span>
                <span class="n">GMM13a</span> <span class="o">=</span> <span class="n">M2</span><span class="o">*</span><span class="n">GMM23</span>
                
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">AdjointMedium</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">GPP13a</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">GPM13a</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">GMP13a</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">GMM13a</span> <span class="o">=</span> <span class="kc">None</span>
            
        <span class="c1"># Verbose: Inform the user if any wavefield contains NaNs of Infs.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            
            <span class="k">if</span> <span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">GPP13</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">GPM13</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> 
              <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">GMP13</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">GMM13</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>
              <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">GPP13</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">GPM13</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> 
              <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">GMP13</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">GMM13</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()):</span>
                
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;GreensFunction_p_w:&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">+</span><span class="mi">100</span><span class="o">*</span><span class="s1">&#39;-&#39;</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;One of the modelled wavefields in the true medium &#39;</span>
                <span class="o">+</span><span class="s1">&#39;contains a NaN (Not a Number) or an Inf (infinite) element.&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">GPP13</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> - GPP13 contains &#39;</span>
                          <span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">GPP13</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39; NaN.&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">GPP13</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> - GPP13 contains &#39;</span>
                          <span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">GPP13</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39; Inf.&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">GPM13</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> - GPM13 contains &#39;</span>
                          <span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">GPM13</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39; NaN.&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">GPM13</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> - GPM13 contains &#39;</span>
                          <span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">GPM13</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39; Inf.&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">GMP13</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> - GMP13 contains &#39;</span>
                          <span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">GMP13</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39; NaN.&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">GMP13</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> - GMP13 contains &#39;</span>
                          <span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">GMP13</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39; Inf.&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">GMM13</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> - GMM13 contains &#39;</span>
                          <span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">GMM13</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39; NaN.&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">GMM13</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> - GMM13 contains &#39;</span>
                          <span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">GMM13</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39; Inf.&#39;</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">AdjointMedium</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                
                <span class="k">if</span> <span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">GPP13a</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">GPM13a</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> 
                  <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">GMP13a</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">GMM13a</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>
                  <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">GPP13a</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">GPM13a</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> 
                  <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">GMP13a</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">GMM13a</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()):</span>
                
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;GreensFunction_p_w:&#39;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">+</span><span class="mi">100</span><span class="o">*</span><span class="s1">&#39;-&#39;</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;One of the modelled wavefields in the adjoint medium &#39;</span>
                    <span class="o">+</span><span class="s1">&#39;contains a NaN (Not a Number) or an Inf (infinite) element.&#39;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">GPP13a</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> - GPP13a contains &#39;</span>
                              <span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">GPP13a</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39; NaN.&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">GPP13a</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> - GPP13a contains &#39;</span>
                              <span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">GPP13a</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39; Inf.&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">GPM13a</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> - GPM13a contains &#39;</span>
                              <span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">GPM13a</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39; NaN.&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">GPM13a</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> - GPM13a contains &#39;</span>
                              <span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">GPM13a</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39; Inf.&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">GMP13a</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> - GMP13a contains &#39;</span>
                              <span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">GMP13a</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39; NaN.&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">GMP13a</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> - GMP13a contains &#39;</span>
                              <span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">GMP13a</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39; Inf.&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">GMM13a</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> - GMM13a contains &#39;</span>
                              <span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">GMM13a</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39; NaN.&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">GMM13a</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> - GMM13a contains &#39;</span>
                              <span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">GMM13a</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39; Inf.&#39;</span><span class="p">)</span>
                
        <span class="n">out</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;GPP&#39;</span><span class="p">:</span><span class="n">GPP13</span><span class="p">,</span><span class="s1">&#39;GPM&#39;</span><span class="p">:</span><span class="n">GPM13</span><span class="p">,</span><span class="s1">&#39;GMP&#39;</span><span class="p">:</span><span class="n">GMP13</span><span class="p">,</span><span class="s1">&#39;GMM&#39;</span><span class="p">:</span><span class="n">GMM13</span><span class="p">,</span>
               <span class="s1">&#39;GPPa&#39;</span><span class="p">:</span><span class="n">GPP13a</span><span class="p">,</span><span class="s1">&#39;GPMa&#39;</span><span class="p">:</span><span class="n">GPM13a</span><span class="p">,</span><span class="s1">&#39;GMPa&#39;</span><span class="p">:</span><span class="n">GMP13a</span><span class="p">,</span><span class="s1">&#39;GMMa&#39;</span><span class="p">:</span><span class="n">GMM13a</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">out</span></div>
    
<div class="viewcode-block" id="Layered_NRM_p_w.FocusingFunction_p_w"><a class="viewcode-back" href="../Layered_NRM_p_w.html#Layered_NRM_p_w.Layered_NRM_p_w.FocusingFunction_p_w">[docs]</a>    <span class="k">def</span> <span class="nf">FocusingFunction_p_w</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x3F</span><span class="p">,</span><span class="n">normalisation</span><span class="o">=</span><span class="s1">&#39;flux&#39;</span><span class="p">,</span><span class="n">InternalMultiples</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;computes the focusing functions between the top surface (:math:`x_3=0`) and the focusing depth defined by the input variable \&#39;x3F\&#39;. We define the focusing depth just below \&#39;x3F\&#39;. Hence, if the focusing depth coincides with an interface the focusing function focuses below that interface.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">    </span>
<span class="sd">        x3F : int,float</span>
<span class="sd">            Focusing depth.</span>
<span class="sd">            </span>
<span class="sd">        normalisation : str, optional</span>
<span class="sd">            For pressure-normalisation set normalisation=&#39;pressure&#39;, for flux-normalisation set normalisation=&#39;flux&#39;. Until now, this function only models the focusing function for flux-normalisation.</span>
<span class="sd">            </span>
<span class="sd">        InternalMultiples : bool, optional</span>
<span class="sd">            To model internal multiples set &#39;InternalMultiples=True&#39;. To ignore internal multiples set &#39;InternalMultiples=False&#39;.</span>
<span class="sd">            </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">    </span>
<span class="sd">        dict</span>
<span class="sd">            Dictionary that contains </span>
<span class="sd">                - **FP**: Downgoing focusing function.</span>
<span class="sd">                - **RP**: Reflection response from above.</span>
<span class="sd">                - **TP**: Transmission response from above.</span>
<span class="sd">                - **FM**: Upgoing focusing function.</span>
<span class="sd">                - **RM**: Reflection response from below.</span>
<span class="sd">                - **TM**: Transmission response from below.</span>
<span class="sd">                - **FPa**: Downgoing focusing function (adjoint medium).</span>
<span class="sd">                - **RPa**: Reflection response from above (adjoint medium).</span>
<span class="sd">                - **TPa**: Transmission response from above (adjoint medium).</span>
<span class="sd">                - **FMa**: Upgoing focusing function (adjoint medium).</span>
<span class="sd">                - **RMa**: Reflection response from below (adjoint medium).</span>
<span class="sd">                - **TMa**: Transmission response from below (adjoint medium).</span>
<span class="sd">            All medium responses are stored in arrays of shape (nf,1). The variables &#39;FPa&#39;, &#39;RPa&#39;, &#39;TPa&#39;, &#39;FMa&#39;, &#39;RMa&#39; and &#39;TMa&#39; are computed only if one sets &#39;AdjointMedium=True&#39;.</span>
<span class="sd">        </span>
<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        </span>
<span class="sd">        - The downgoing focusing funtion :math:`\\tilde{F}_1^+` is computed by inverting the expressions for the transmission from above :math:`\\tilde{T}^+`:</span>
<span class="sd">            :math:`\\tilde{F}_{1,n}^+ = \\tilde{F}_{1,n-1}^+ (\\tilde{w}_n^+)^{-1} (1 - \\tilde{w}_n^+ \\tilde{R}_{n-1}^{\cap} \\tilde{w}_n^- \\tilde{r}_n^{\cup} )^{-1} (\\tilde{t}_n^+)^{-1}`</span>
<span class="sd">        - The upgoing focusing function is computed by applying the reflection response :math:`R^{\cup}` on the downgoing focusing funtion :math:`\\tilde{F}_1^+`:</span>
<span class="sd">            :math:`\\tilde{F}_{1,n}^- = \\tilde{R}^{\cup} \\tilde{F}_{1,n}^+`.</span>
<span class="sd">        </span>
<span class="sd">        References</span>
<span class="sd">        ----------</span>
<span class="sd">        Kees document as soon as it is published.</span>
<span class="sd">        </span>
<span class="sd">        Examples</span>
<span class="sd">        --------</span>

<span class="sd">        &gt;&gt;&gt; from Layered_NRM_p_w import Layered_NRM_p_w as LM</span>
<span class="sd">        &gt;&gt;&gt; import numpy as np</span>

<span class="sd">        &gt;&gt;&gt; F=LM( nt=1024,dt=0.005,x3vec=np.array([10,150,200]),</span>
<span class="sd">        &gt;&gt;&gt;       avec=np.array([1,2,3]),bvec=np.array([0.4,3.14,2]),</span>
<span class="sd">        &gt;&gt;&gt;       g1vec=np.array([0.9,2.1,0.3]),g3vec=np.array([0.7,1.14,0.2]),</span>
<span class="sd">        &gt;&gt;&gt;       p1=2e-4,ReciprocalMedium=False,AdjointMedium=True )</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="c1"># Check if normalisation is set correctly</span>
        <span class="k">if</span> <span class="n">normalisation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="s1">&#39;flux&#39;</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;FocusingFunction_p_w: This function only models the focusing function for flux-normalisation. (For pressure-normalistiont the required equations have to be derived.)&#39;</span><span class="p">)</span>
        
        <span class="c1"># Insert transparent interfaces at the focusing depth level.</span>
        <span class="c1"># The insertion implicitly checks that x3F is non-negative </span>
        <span class="c1"># and real-valued.</span>
        <span class="c1"># If the focusing depth is greater than, or equal to the deepest </span>
        <span class="c1"># interface, we insert another transparent layer below the focusing </span>
        <span class="c1"># depth to be able to compute scattering coefficients at the focusing </span>
        <span class="c1"># depth without getting an index error.</span>
        <span class="k">if</span> <span class="n">x3F</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x3vec</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">Tmp_medium</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Insert_layer</span><span class="p">(</span><span class="n">x3</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x3F</span><span class="p">,</span><span class="n">x3F</span><span class="o">+</span><span class="mi">1</span><span class="p">]),</span>
                                           <span class="n">UpdateSelf</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Tmp_medium</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Insert_layer</span><span class="p">(</span><span class="n">x3</span><span class="o">=</span><span class="n">x3F</span><span class="p">,</span><span class="n">UpdateSelf</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        
        <span class="n">X3vec</span> <span class="o">=</span> <span class="n">Tmp_medium</span><span class="p">[</span><span class="s1">&#39;x3vec&#39;</span><span class="p">]</span>
        <span class="n">Bvec</span> <span class="o">=</span> <span class="n">Tmp_medium</span><span class="p">[</span><span class="s1">&#39;bvec&#39;</span><span class="p">]</span>
        <span class="n">G3vec</span> <span class="o">=</span> <span class="n">Tmp_medium</span><span class="p">[</span><span class="s1">&#39;g3vec&#39;</span><span class="p">]</span>
        <span class="n">P3</span>    <span class="o">=</span> <span class="n">Tmp_medium</span><span class="p">[</span><span class="s1">&#39;p3&#39;</span><span class="p">]</span>
        <span class="n">P3n</span>   <span class="o">=</span> <span class="n">Tmp_medium</span><span class="p">[</span><span class="s1">&#39;p3n&#39;</span><span class="p">]</span>
        
        <span class="c1"># Index of the focusing depth</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">X3vec</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">x3F</span><span class="p">)</span>
        
        <span class="c1"># Only allow propagating waves to model the focusing function</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">iscomplex</span><span class="p">(</span><span class="n">P3</span><span class="p">[:</span><span class="n">f</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">iscomplex</span><span class="p">(</span><span class="n">P3n</span><span class="p">[:</span><span class="n">f</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;FocusingFunction_p_w: (Here,) We only define the focusing function for propagating waves, i.e. not evanescent waves.&#39;</span><span class="p">)</span>
        
        <span class="c1"># Vector with layer thicknesses</span>
        <span class="n">dx3vec</span> <span class="o">=</span> <span class="n">X3vec</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">dx3vec</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">X3vec</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">-</span><span class="n">X3vec</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="c1"># Down- and upgoing focusing functions: Initial value</span>
        <span class="c1"># Here every frequency component has an amplitude equal to one. Hence,</span>
        <span class="c1"># the total wavefield has a strength of sqrt(nt)</span>
        <span class="c1"># When an ifft is applied the wavefield is scaled by 1/sqrt(nt).</span>
        <span class="c1"># Hence in the time domain the wavefield has an amplitude equal to one.</span>
        <span class="n">FP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">nf</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
        <span class="n">FM</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">nf</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
        
        <span class="c1"># Reflection responses: Initial value</span>
        <span class="n">RP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">nf</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
        <span class="n">RM</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">nf</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
        
        <span class="c1"># Here every frequency component has an amplitude equal to one. Hence,</span>
        <span class="c1"># the total wavefield has a strength of sqrt(nt)</span>
        <span class="c1"># When an ifft is applied the wavefield is scaled by 1/sqrt(nt).</span>
        <span class="c1"># Hence in the time domain the wavefield has an amplitude equal to one.</span>
        <span class="n">TP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">nf</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
        <span class="n">TM</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">nf</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
        
        <span class="c1"># Internal multiple operator: Initial value</span>
        <span class="n">M1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">nf</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
        <span class="n">M2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">nf</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">AdjointMedium</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">FPa</span> <span class="o">=</span> <span class="n">FP</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">FMa</span> <span class="o">=</span> <span class="n">FM</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">RPa</span> <span class="o">=</span> <span class="n">RP</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">RMa</span> <span class="o">=</span> <span class="n">RP</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">TPa</span> <span class="o">=</span> <span class="n">TP</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">TMa</span> <span class="o">=</span> <span class="n">TP</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">FPa</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">FMa</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">RPa</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">TPa</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">RMa</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">TMa</span> <span class="o">=</span> <span class="kc">None</span>
    
        <span class="c1"># Loop over f+1 interfaces</span>
        <span class="c1"># Thus, the wavefield propagates to the focusing depth, and scatters</span>
        <span class="c1"># at the focusing depth.</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">f</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            
            <span class="c1"># Scattering coefficients</span>
            <span class="n">ScatCoeffs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">RT_p_w</span><span class="p">(</span><span class="n">beta_u</span><span class="o">=</span><span class="n">Bvec</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>  <span class="p">,</span><span class="n">g3_u</span><span class="o">=</span><span class="n">G3vec</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>  <span class="p">,</span><span class="n">p3_u</span><span class="o">=</span><span class="n">P3</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>  <span class="p">,</span><span class="n">p3n_u</span><span class="o">=</span><span class="n">P3n</span><span class="p">[</span><span class="n">n</span><span class="p">],</span>
                                     <span class="n">beta_l</span><span class="o">=</span><span class="n">Bvec</span><span class="p">[</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span><span class="n">g3_l</span><span class="o">=</span><span class="n">G3vec</span><span class="p">[</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span><span class="n">p3_l</span><span class="o">=</span><span class="n">P3</span><span class="p">[</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span><span class="n">p3n_l</span><span class="o">=</span><span class="n">P3n</span><span class="p">[</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span>
                                     <span class="n">normalisation</span><span class="o">=</span><span class="n">normalisation</span><span class="p">)</span>
            
            <span class="n">rP</span> <span class="o">=</span> <span class="n">ScatCoeffs</span><span class="p">[</span><span class="s1">&#39;rP&#39;</span><span class="p">]</span>
            <span class="n">tP</span> <span class="o">=</span> <span class="n">ScatCoeffs</span><span class="p">[</span><span class="s1">&#39;tP&#39;</span><span class="p">]</span>
            <span class="n">rM</span> <span class="o">=</span> <span class="n">ScatCoeffs</span><span class="p">[</span><span class="s1">&#39;rM&#39;</span><span class="p">]</span>
            <span class="n">tM</span> <span class="o">=</span> <span class="n">ScatCoeffs</span><span class="p">[</span><span class="s1">&#39;tM&#39;</span><span class="p">]</span>
            
            <span class="c1"># Propagators</span>
            <span class="n">W</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">W_propagators_p_w</span><span class="p">(</span><span class="n">p3</span><span class="o">=</span><span class="n">P3</span><span class="p">[</span><span class="n">n</span><span class="p">],</span><span class="n">p3n</span><span class="o">=</span><span class="n">P3n</span><span class="p">[</span><span class="n">n</span><span class="p">],</span><span class="n">g3</span><span class="o">=</span><span class="n">G3vec</span><span class="p">[</span><span class="n">n</span><span class="p">],</span><span class="n">dx3</span><span class="o">=</span><span class="n">dx3vec</span><span class="p">[</span><span class="n">n</span><span class="p">])</span>
            <span class="n">WP</span> <span class="o">=</span> <span class="n">W</span><span class="p">[</span><span class="s1">&#39;wP&#39;</span><span class="p">]</span>
            <span class="n">WM</span> <span class="o">=</span> <span class="n">W</span><span class="p">[</span><span class="s1">&#39;wM&#39;</span><span class="p">]</span>
        
            <span class="k">if</span> <span class="n">InternalMultiples</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">M1</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">RM</span><span class="o">*</span><span class="n">WM</span><span class="o">*</span><span class="n">rP</span><span class="o">*</span><span class="n">WP</span><span class="p">)</span>
                <span class="n">M2</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">rP</span><span class="o">*</span><span class="n">WP</span><span class="o">*</span><span class="n">RM</span><span class="o">*</span><span class="n">WM</span><span class="p">)</span>
            
            <span class="c1"># Update focusing functions and reflection / transmission responses</span>
            <span class="n">FP</span> <span class="o">=</span> <span class="n">FP</span><span class="o">/</span><span class="n">WP</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">WP</span><span class="o">*</span><span class="n">RM</span><span class="o">*</span><span class="n">WM</span><span class="o">*</span><span class="n">rP</span><span class="p">)</span><span class="o">/</span><span class="n">tP</span>
            <span class="n">RP</span> <span class="o">=</span> <span class="n">RP</span> <span class="o">+</span> <span class="n">TM</span><span class="o">*</span><span class="n">WM</span><span class="o">*</span><span class="n">rP</span><span class="o">*</span><span class="n">WP</span><span class="o">*</span><span class="n">M1</span><span class="o">*</span><span class="n">TP</span>
            <span class="n">RM</span> <span class="o">=</span> <span class="n">rM</span> <span class="o">+</span> <span class="n">tP</span><span class="o">*</span><span class="n">WP</span><span class="o">*</span><span class="n">RM</span><span class="o">*</span><span class="n">WM</span><span class="o">*</span><span class="n">M2</span><span class="o">*</span><span class="n">tM</span>
            <span class="n">TP</span> <span class="o">=</span> <span class="n">tP</span><span class="o">*</span><span class="n">WP</span><span class="o">*</span><span class="n">M1</span><span class="o">*</span><span class="n">TP</span>
            <span class="n">TM</span> <span class="o">=</span> <span class="n">TM</span><span class="o">*</span><span class="n">WM</span><span class="o">*</span><span class="n">M2</span><span class="o">*</span><span class="n">tM</span>  
            <span class="n">FM</span> <span class="o">=</span> <span class="n">RP</span><span class="o">*</span><span class="n">FP</span>
            
            <span class="c1"># Model focusing functions in the adjoint medium</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">AdjointMedium</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">rP</span> <span class="o">=</span> <span class="n">ScatCoeffs</span><span class="p">[</span><span class="s1">&#39;rPa&#39;</span><span class="p">]</span>
                <span class="n">tP</span> <span class="o">=</span> <span class="n">ScatCoeffs</span><span class="p">[</span><span class="s1">&#39;tPa&#39;</span><span class="p">]</span>
                <span class="n">rM</span> <span class="o">=</span> <span class="n">ScatCoeffs</span><span class="p">[</span><span class="s1">&#39;rMa&#39;</span><span class="p">]</span>
                <span class="n">tM</span> <span class="o">=</span> <span class="n">ScatCoeffs</span><span class="p">[</span><span class="s1">&#39;tMa&#39;</span><span class="p">]</span>
                <span class="n">WP</span> <span class="o">=</span> <span class="n">W</span><span class="p">[</span><span class="s1">&#39;wPa&#39;</span><span class="p">]</span>
                <span class="n">WM</span> <span class="o">=</span> <span class="n">W</span><span class="p">[</span><span class="s1">&#39;wMa&#39;</span><span class="p">]</span>
            
                <span class="k">if</span> <span class="n">InternalMultiples</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">M1</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">RMa</span><span class="o">*</span><span class="n">WM</span><span class="o">*</span><span class="n">rP</span><span class="o">*</span><span class="n">WP</span><span class="p">)</span>
                    <span class="n">M2</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">rP</span><span class="o">*</span><span class="n">WP</span><span class="o">*</span><span class="n">RMa</span><span class="o">*</span><span class="n">WM</span><span class="p">)</span>
                
                <span class="c1"># Update focusing functions and reflection / transmission responses</span>
                <span class="n">FPa</span> <span class="o">=</span> <span class="n">FPa</span><span class="o">/</span><span class="n">WP</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">WP</span><span class="o">*</span><span class="n">RMa</span><span class="o">*</span><span class="n">WM</span><span class="o">*</span><span class="n">rP</span><span class="p">)</span><span class="o">/</span><span class="n">tP</span>
                <span class="n">RPa</span> <span class="o">=</span> <span class="n">RPa</span> <span class="o">+</span> <span class="n">TMa</span><span class="o">*</span><span class="n">WM</span><span class="o">*</span><span class="n">rP</span><span class="o">*</span><span class="n">WP</span><span class="o">*</span><span class="n">M1</span><span class="o">*</span><span class="n">TPa</span>
                <span class="n">RMa</span> <span class="o">=</span> <span class="n">rM</span> <span class="o">+</span> <span class="n">tP</span><span class="o">*</span><span class="n">WP</span><span class="o">*</span><span class="n">RMa</span><span class="o">*</span><span class="n">WM</span><span class="o">*</span><span class="n">M2</span><span class="o">*</span><span class="n">tM</span>
                <span class="n">TPa</span> <span class="o">=</span> <span class="n">tP</span><span class="o">*</span><span class="n">WP</span><span class="o">*</span><span class="n">M1</span><span class="o">*</span><span class="n">TPa</span>
                <span class="n">TMa</span> <span class="o">=</span> <span class="n">TMa</span><span class="o">*</span><span class="n">WM</span><span class="o">*</span><span class="n">M2</span><span class="o">*</span><span class="n">tM</span>  
                <span class="n">FMa</span> <span class="o">=</span> <span class="n">RPa</span><span class="o">*</span><span class="n">FPa</span>
                
        <span class="c1"># Verbose: Inform the user if any wavefield contains NaNs of Infs.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            
            <span class="k">if</span> <span class="p">(</span>   <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">FP</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">FM</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> 
                <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">RP</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">RM</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> 
                <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">TP</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">TM</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>
                <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">FP</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">FM</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>
                <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">RP</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">TP</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> 
                <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">RM</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">TM</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;FocusingFunction_p_w:&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">+</span><span class="mi">100</span><span class="o">*</span><span class="s1">&#39;-&#39;</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;One of the modelled wavefields in the true medium contains a NaN (Not a Number) or an Inf (infinite) element.&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">FP</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> - FP contains &#39;</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">FP</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39; NaN.&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">FP</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> - FP contains &#39;</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">FP</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39; Inf.&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">RP</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> - RP contains &#39;</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">RP</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39; NaN.&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">RP</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> - RP contains &#39;</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">RP</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39; Inf.&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">TP</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> - TP contains &#39;</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">TP</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39; NaN.&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">TP</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> - TP contains &#39;</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">TP</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39; Inf.&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">FM</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> - FM contains &#39;</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">FM</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39; NaN.&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">FM</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> - FM contains &#39;</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">FM</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39; Inf.&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">RM</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> - RM contains &#39;</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">RM</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39; NaN.&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">RM</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> - RM contains &#39;</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">RM</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39; Inf.&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">TM</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> - TM contains &#39;</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">TM</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39; NaN.&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">TM</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> - TM contains &#39;</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">TM</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39; Inf.&#39;</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">AdjointMedium</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                
                <span class="k">if</span> <span class="p">(</span>   <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">FPa</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">FMa</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> 
                    <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">RPa</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">RMa</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> 
                    <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">TPa</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">TMa</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>
                    <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">FPa</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">FMa</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>
                    <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">RPa</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">TPa</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> 
                    <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">RMa</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">TMa</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;FocusingFunction_p_w:&#39;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">+</span><span class="mi">100</span><span class="o">*</span><span class="s1">&#39;-&#39;</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;One of the modelled wavefields in the adoint medium contains a NaN (Not a Number) or an Inf (infinite) element.&#39;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">FPa</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> - FPa contains &#39;</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">FPa</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39; NaN.&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">FPa</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> - FPa contains &#39;</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">FPa</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39; Inf.&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">RPa</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> - RPa contains &#39;</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">RPa</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39; NaN.&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">RPa</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> - RPa contains &#39;</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">RPa</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39; Inf.&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">TPa</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> - TPa contains &#39;</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">TPa</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39; NaN.&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">TPa</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> - TPa contains &#39;</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">TPa</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39; Inf.&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">FMa</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> - FMa contains &#39;</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">FMa</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39; NaN.&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">FMa</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> - FMa contains &#39;</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">FMa</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39; Inf.&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">RMa</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> - RMa contains &#39;</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">RMa</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39; NaN.&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">RMa</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> - RMa contains &#39;</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">RMa</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39; Inf.&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">TMa</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> - TMa contains &#39;</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">TMa</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39; NaN.&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">TMa</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> - TMa contains &#39;</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">TMa</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39; Inf.&#39;</span><span class="p">)</span>
                
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

                
        <span class="n">out</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;FP&#39;</span><span class="p">:</span><span class="n">FP</span>  <span class="p">,</span><span class="s1">&#39;RP&#39;</span><span class="p">:</span><span class="n">RP</span>  <span class="p">,</span><span class="s1">&#39;TP&#39;</span><span class="p">:</span><span class="n">TP</span>  <span class="p">,</span><span class="s1">&#39;FM&#39;</span><span class="p">:</span><span class="n">FM</span>  <span class="p">,</span><span class="s1">&#39;RM&#39;</span><span class="p">:</span><span class="n">RM</span>  <span class="p">,</span><span class="s1">&#39;TM&#39;</span><span class="p">:</span><span class="n">TM</span><span class="p">,</span>
             <span class="s1">&#39;FPa&#39;</span><span class="p">:</span><span class="n">FPa</span><span class="p">,</span><span class="s1">&#39;RPa&#39;</span><span class="p">:</span><span class="n">RPa</span><span class="p">,</span><span class="s1">&#39;TPa&#39;</span><span class="p">:</span><span class="n">TPa</span><span class="p">,</span><span class="s1">&#39;FMa&#39;</span><span class="p">:</span><span class="n">FMa</span><span class="p">,</span><span class="s1">&#39;RMa&#39;</span><span class="p">:</span><span class="n">RMa</span><span class="p">,</span><span class="s1">&#39;TMa&#39;</span><span class="p">:</span><span class="n">TMa</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">out</span></div></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Non-reciprocal wavefields (1.5 D) 28-03-2018 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2018, Christian Reinicke, Kees Wapenaar, and Evert Slob.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.7.2.
    </div>
  </body>
</html>